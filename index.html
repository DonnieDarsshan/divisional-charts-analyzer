<!DOCTYPE html>
<html lang="en">



<head>
<meta charset="UTF-8">
<title>Divisonal Charts Analyzer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">








<style>
/* =========================================================
   EMERALD MATRIX √ó EGYPTIAN TEMPLE
   (CLEANED + FIXED + CLASSIC GLOSSY KUNDALI)
   ========================================================= */

:root{
  --bg-main:
    radial-gradient(circle at top,#022c22 0%,#000000 70%);
  --panel:#021b16;
  --border:#10b981;
  --soft:#064e3b;
  --text:#ecfdf5;
  --accent:#d4af37;
  --glow:0 0 14px rgba(16,185,129,.45);

/* ===== LEVEL ROW COLORS (USER-LOCKED EXACT COLORS) ===== */
/* 1Ô∏è‚É£ Planet / Star Lord */
--row-planet:  rgba(102,0,51,0.55);   /* #660033 */

/* 2Ô∏è‚É£ Sub Lord / Star of Sub Lord */
--row-sub:     rgba(0,0,179,0.50);    /* #0000b3 */

/* 3Ô∏è‚É£ Sub-Sub / Star of Sub-Sub */
--row-subsub:  rgba(89,0,179,0.55);   /* #5900b3 */


}





/* =========================
   GLOBAL
   ========================= */
body{
  background:var(--bg-main);
  color:var(--text);
  font-family:Segoe UI,Arial,sans-serif;
  padding:20px;
}









/* HEADINGS */



h2{
  text-align:center;
  font-size:36px;
  font-weight:1000;
  letter-spacing:4px;
  text-transform:uppercase;



/* =========================
   STICKY SECTION HEADINGS
   ========================= */
h2,
h3{
  position: sticky;
  top: 68px;              /* below top controls */
  z-index: 3000;
  background: var(--bg-main);
  padding-top: 10px;
  padding-bottom: 10px;
}

/* prevent text clipping on stick */
h2::before,
h3::before{
  content:"";
  position:absolute;
  top:-12px;
  left:0;
  right:0;
  height:12px;
  background:var(--bg-main);
}








  /* TWO-COLOR GRADIENT TEXT */
  background:linear-gradient(
    90deg,
    #10b981,
    #d4af37
  );

  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  color:transparent;
}










/* =========================
   TABLES
   ========================= */
table{
  width:100%;
  border-collapse:collapse;
  background:var(--panel);
  border:1px solid var(--border);
  box-shadow:var(--glow);
  margin-top:16px;
}



/* hide input table by default */
#inputTable{
  display:none;
}


th,td{
  border:1.5px solid rgba(16,185,129,0.65); /* stronger emerald grid */
  padding:8px;
  text-align:center;
}





th{
  background:linear-gradient(180deg,#064e3b,#021b16);
  color:#fef3c7;
  font-weight:900;
  letter-spacing:.5px;
}

/* =========================
   INPUTS
   ========================= */
input,select{
  background:#021b16;
  color:#ecfdf5;
  border:1px solid var(--border);
  border-radius:6px;
  padding:6px 10px;
  font-weight:800;
  text-align:center;
  box-shadow:inset 0 0 6px rgba(16,185,129,.35);
}

input:disabled{ opacity:.45; }

/* =========================
   BUTTONS
   ========================= */
button{
  background:linear-gradient(135deg,#10b981,#d4af37);
  border:none;
  color:#021b16;
  padding:8px 16px;
  font-weight:900;
  cursor:pointer;
  box-shadow:0 0 14px rgba(16,185,129,.55);
  margin:6px;
  letter-spacing:.6px;
}

button:hover{
  background:linear-gradient(135deg,#34d399,#facc15);
}

.controls{
  text-align:center;
  margin-top:18px;
}

hr{
  border:none;
  height:1px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);
  margin:22px 0;
}

/* =========================
   PIVOT BAR
   ========================= */
.pivotBar{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:14px;
  flex-wrap:wrap;
  margin-bottom:16px;
  padding:10px 14px;
  background:linear-gradient(180deg,#021b16,#010a08);
  border:1px solid var(--border);
  border-radius:10px;
  box-shadow:0 0 16px rgba(16,185,129,.45);
  font-weight:900;
  color:var(--accent);
}

.pivotBar label{
  display:flex;
  align-items:center;
  gap:6px;
  cursor:pointer;
}

.pivotBar input[type="checkbox"]{
  accent-color:#10b981;
  transform:scale(1.1);
}







/* =========================
   SOUTH INDIAN KUNDALI
   ========================= */
#siKundali{
  background:#021b16;
  border:2px solid var(--border);
  box-shadow:0 0 26px rgba(16,185,129,.55);
}

.siCell{
  border:1px solid var(--soft);
  padding:10px;
  position:relative;
  font-size:13px;
  background:#021b16;
  cursor:pointer;
}

.siCenter{ background:#010a08; }

.siSign{
  position:absolute;
  bottom:4px;
  right:6px;
  font-size:13px;
  font-weight:800;
  color:var(--accent);
}

.siHouse{
  position:absolute;
  top:4px;
  left:6px;
  font-size:14px;
  font-weight:900;
  color:#fef3c7;
}

.siList{
  margin-top:18px;
  display:flex;
  flex-direction:column;
  gap:4px;
  white-space:nowrap;
}



/* =========================
   CUSP DISPLAY INSIDE KUNDALI
   ========================= */
.siCusp{
  font-size:12px;
  font-weight:800;
  color:#facc15;
  margin-top:2px;
}








/* =========================================
   KUNDALI ‚Äì BLOOD RITUAL RED (GLOSSY, TRANSPARENT)
   ========================================= */
#siKundali .siCell.selectedRasi{
  background:radial-gradient(
    circle at center,
    rgba(180,25,25,0.38),   /* glowing blood core */
    rgba(40,0,0,0.88),      /* dark ritual edge */
    rgba(5,0,0,0.97)
  );
  box-shadow:
    inset 0 0 26px rgba(255,60,60,0.55),
    inset 0 0 6px rgba(0,0,0,0.85),
    0 0 20px rgba(120,0,0,0.65);
  border:2px solid rgba(150,30,30,0.85);
}





#siKundali .siCell.selectedRasi *{
  color:#ecfdf5 !important;
}






/* =========================================
   COUNTER TABLE ‚Äì DARK RED MEMORY SELECTION
   ========================================= */





#counterTable tr.selectedRow[data-color="purple"]{
  background:linear-gradient(
    135deg,
    rgba(102,0,102,0.30),
    rgba(20,0,20,0.90)
  );
  box-shadow:
    inset 0 0 18px rgba(180,60,180,0.40),
    inset 0 0 3px rgba(0,0,0,0.85);
}






#counterTable tr.selectedRow[data-color="maroon"]{
  background:linear-gradient(
    135deg,
    rgba(255,0,102,0.26),
    rgba(50,0,25,0.82)
  );
  box-shadow:
    inset 0 0 16px rgba(255,90,170,0.5),
    inset 0 0 2px rgba(0,0,0,0.8);
}







#counterTable tr.selectedRow td{
  color:#ffffff;
  font-weight:normal;
}











/* =========================================================
   PER-ELEMENT COLOR SELECTION (NO GLOBAL STATE)
   ========================================================= */






#siKundali .siCell.selectedRasi[data-color="purple"]{
  background:radial-gradient(
    circle at center,
    rgba(102,0,204,0.30),
    rgba(55,0,120,0.65),
    rgba(20,0,45,0.85)
  );
  box-shadow:
    inset 0 0 24px rgba(160,100,255,0.55),
    inset 0 0 6px rgba(0,0,0,0.8),
    0 0 18px rgba(102,0,204,0.6);
  border:2px solid rgba(102,0,204,0.65);
}







#siKundali .siCell.selectedRasi[data-color="maroon"]{
  background:radial-gradient(
    circle at center,
    rgba(255,0,102,0.28),
    rgba(120,0,50,0.65),
    rgba(30,0,15,0.85)
  );
  box-shadow:
    inset 0 0 24px rgba(255,80,160,0.55),
    inset 0 0 6px rgba(0,0,0,0.75),
    0 0 18px rgba(255,0,102,0.6);
  border:2px solid rgba(255,0,102,0.65);
}




/* text safety */
#siKundali .siCell.selectedRasi *{
  color:#ecfdf5 !important;
}

















/* =========================================================
   SOUTH INDIAN KUNDALI STYLE
   EMERALD MATRIX √ó EGYPTIAN (OVERRIDES OLD FIRE)
   ========================================================= */

#siKundali{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  grid-template-rows:repeat(4,1fr);
  width:520px;
  aspect-ratio:1/1;
  background:var(--panel);
  border:2px solid var(--border);
  box-shadow:0 0 26px rgba(16,185,129,.55);
}

.siCell{
  border:1px solid var(--soft);
  padding:10px;
  position:relative;
  font-size:13px;
}

.siCenter{
  background:#010a08;
}

.siSign{
  position:absolute;
  bottom:4px;
  right:6px;
  font-size:13px;
  font-weight:800;
  color:var(--accent);
}

.siHouse{
  position:absolute;
  top:4px;
  left:6px;
  font-size:14px;
  font-weight:900;
  color:#fef3c7;
}

.siList{
  margin-top:18px;
  display:flex;
  flex-direction:column;
  gap:4px;
  white-space:nowrap;
}







/* =========================================
   COLOR PALETTE (WINDOWS PAINT STYLE)
   ========================================= */
#colorPalette{
  display:flex;
  gap:8px;
  margin-left:10px;
}

.colorBox{
  width:22px;
  height:22px;
  border:2px solid #000000;
  cursor:pointer;
}



.colorBox.maroon{
  background:radial-gradient(
    circle at top left,
    #ff0066,
    #330015 70%
  );
}



.colorBox.active{
  outline:3px solid #ffffff;
}










/* =========================================
   COUNTER TABLE ‚Äì PER ROW COLOR MEMORY
   ========================================= */



#counterTable tr.selectedRow[data-color="purple"]{
  background:linear-gradient(
    135deg,
    rgba(102,0,204,0.28),
    rgba(35,0,70,0.85)
  );
  box-shadow:
    inset 0 0 16px rgba(160,100,255,0.5),
    inset 0 0 2px rgba(0,0,0,0.8);
}





#counterTable tr.selectedRow[data-color="darkred"]{
  background:linear-gradient(
    135deg,
    rgba(180,40,40,0.28),
    rgba(20,0,0,0.82)
  );
  box-shadow:
    inset 0 0 16px rgba(220,60,60,0.45),
    inset 0 0 2px rgba(0,0,0,0.8);
}




#counterTable tr.selectedRow td{
  color:#ffffff;
  font-weight:normal;
}












/* =========================================
   FIX PLL PLANET COLUMN WRAPPING
   ========================================= */
#pllContainer table td:nth-child(2),
#pllContainer table th:nth-child(2){
  white-space: nowrap;     /* prevent line break */
  min-width: 80px;        /* enough for "Chandra $" */
  font-weight: 600;
}







/* =========================================
   FLOATING TABLE NAV BAR (MAC-DOCK STYLE)
   ========================================= */
#tableNavBar{
  position:fixed;
  top:12px;
  right:14px;
  display:flex;
  gap:6px;
  z-index:9999;
  padding:6px 8px;
  background:rgba(2,27,22,0.85);
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:0 0 14px rgba(16,185,129,.45);
}

#tableNavBar button{
  all:unset;                 /* üî• kill global button styles */
  width:24px;
  height:24px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:6px;
  font-size:13px;
  font-weight:900;
  cursor:pointer;
  background:linear-gradient(135deg,#10b981,#d4af37);
  color:#021b16;
  box-shadow:0 0 6px rgba(16,185,129,.55);
}



/* =========================
   MINI BTR INPUTS (MM : SS)
   ========================= */
#tableNavBar .btrMiniBox{
  all:unset;
  width:24px;
  height:24px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:6px;
  font-size:12px;
  font-weight:900;
  text-align:center;
  background:linear-gradient(135deg,#10b981,#d4af37);
  color:#021b16;
  box-shadow:0 0 6px rgba(16,185,129,.55);
  cursor:text;
  pointer-events:none;

}


#tableNavBar button:hover{
  background:linear-gradient(135deg,#34d399,#facc15);
}











/* =========================================================
   LEVEL-BASED ROW COLORING
   TABLE 2, 4, 5 ONLY
   ========================================================= */

/* =========================================================
   LEVEL-BASED ROW COLORING (CHECKBOX CONTROLLED)
   TABLE 2, 4, 5 ONLY
   ========================================================= */




/* =========================
   LEVEL THEME ‚Äî DARK ‚Üí TOO DARK GRADIENTS
   (NO LIGHT COLORS, NO PURPLE)
   ========================= */

body[data-level-theme="on"]
#pllContainer tr.lvl-planet,
body[data-level-theme="on"]
#cuspalPromiseContainer tr.lvl-planet,
body[data-level-theme="on"]
#dynamicCuspalPromiseContainer tr.lvl-planet{
  background:#3f0016;
}


body[data-level-theme="on"]
#pllContainer tr.lvl-sub,
body[data-level-theme="on"]
#cuspalPromiseContainer tr.lvl-sub,
body[data-level-theme="on"]
#dynamicCuspalPromiseContainer tr.lvl-sub{
  background:#000033;
}


body[data-level-theme="on"]
#pllContainer tr.lvl-subsub,
body[data-level-theme="on"]
#cuspalPromiseContainer tr.lvl-subsub,
body[data-level-theme="on"]
#dynamicCuspalPromiseContainer tr.lvl-subsub{
  background: linear-gradient(
    90deg,
    #003333,   /* dark teal */
    #002020,   /* deep teal */
    #001010    /* almost black teal */
  );
}







/* =========================================================
   TABLE 1 ‚Äì FORCE FULL WIDTH + NO WRAP (FIX SHRINK ISSUE)
   ========================================================= */



/* Planet column ‚Äì NEVER wrap */
#counterTable th:nth-child(1),
#counterTable td:nth-child(1){
  white-space: nowrap;           /* üîí prevent line break */
  min-width: 180px;              /* enough for long labels */
  font-weight: 900;
}

/* Forward & Retro ‚Äì compact but readable */
#counterTable th:nth-child(2),
#counterTable td:nth-child(2),
#counterTable th:nth-child(8),
#counterTable td:nth-child(8){
  width: 70px;
  white-space: nowrap;
}

/* Lordship & Summation ‚Äì allow space */
#counterTable th:nth-child(3),
#counterTable td:nth-child(3),
#counterTable th:nth-child(4),
#counterTable td:nth-child(4){
  min-width: 110px;
  white-space: nowrap;
}

/* Tara column */
#counterTable th:nth-child(5),
#counterTable td:nth-child(5){
  min-width: 120px;
  white-space: nowrap;
}

/* Degree Difference */
#counterTable th:nth-child(6),
#counterTable td:nth-child(6){
  min-width: 120px;
  white-space: nowrap;
}

/* West Aspect */
#counterTable th:nth-child(7),
#counterTable td:nth-child(7){
  min-width: 120px;
  white-space: nowrap;
}

/* State column */
#counterTable th:nth-child(9),
#counterTable td:nth-child(9){
  min-width: 90px;
  white-space: nowrap;
}












/* =========================================================
   TABLE 1 ‚Äì TRUE AUTO-FIT (NO FIXED WIDTHS)
   ========================================================= */

#counterTable{
  width:100%;
  table-layout:auto;      /* üî• allow browser auto sizing */
}

/* Prevent wrapping ONLY for planet names */
#counterTable th:first-child,
#counterTable td:first-child{
  white-space:nowrap;
  font-weight:900;
}

/* Improve spacing for all columns */
#counterTable th,
#counterTable td{
  padding:10px 12px;
}











/* =========================
   SOUTH INDIAN KUNDALI ‚Äì CONTROL ROW SPLIT
   ========================= */

.siControls{
  flex-direction:column;
  gap:10px;
}

/* shared row style */
.siRow{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:14px;
  flex-wrap:wrap;
}

/* top row ‚Äì dropdowns + palette */
.siRowTop{
  border-bottom:1px solid rgba(16,185,129,0.35);
  padding-bottom:8px;
}

/* bottom row ‚Äì only checkboxes */
.siRowBottom{
  font-weight:900;
}

.siRowBottom label{
  display:flex;
  align-items:center;
  gap:6px;
}






</style>





























</head>

<body>


<!-- =========================================
     FLOATING TABLE NAVIGATION BAR
     ========================================= -->



<div id="tableNavBar">

  <button
    type="button"
    tabindex="-1"
    onmousedown="event.preventDefault()"
    onclick="shiftBTRSeconds(-60)">
    &lt;
  </button>


		<input
		  id="btrMiniMin"
		  class="btrMiniBox"
		  readonly
		>

		<span>:</span>

		<input
		  id="btrMiniSec"
		  class="btrMiniBox"
		  readonly
		>


  <button
    type="button"
    tabindex="-1"
    onmousedown="event.preventDefault()"
    onclick="shiftBTRSeconds(60)">
    &gt;
  </button>

  <button type="button" onclick="scrollToTable('nav1')">A</button>
  <button type="button" onclick="scrollToTable('nav2')">B</button>
  <button type="button" onclick="scrollToTable('table1')">1</button>
  <button type="button" onclick="scrollToTable('table2')">2</button>
  <button type="button" onclick="scrollToTable('table3')">3</button>
  <button type="button" onclick="scrollToTable('table4')">4</button>
  <button type="button" onclick="scrollToTable('table5')">5</button>

</div>












<h2 id="nav1">DIVISIONAL CHARTS ANALYZER</h2>


<!-- =========================
     PERSON NAME + DATE + TIME (SINGLE LINE)
     ========================= -->
<div style="
  display:flex;
  justify-content:center;
  align-items:center;
  gap:14px;
  margin-bottom:14px;
  font-weight:800;
  flex-wrap:wrap;
">

  <span>Person Name :</span>
  <input id="personName"
    style="width:180px"
    placeholder="NAME"
    maxlength="20"
    oninput="this.value=this.value
      .toUpperCase()
      .replace(/[^A-Z0-9\s]/g,'')">

  <span>Date :</span>
  <input id="btr_dd" maxlength="2" placeholder="DD" style="width:36px">
  <span>-</span>
  <input id="btr_mm" maxlength="2" placeholder="MM" style="width:36px">
  <span>-</span>
  <input id="btr_yyyy" maxlength="4" placeholder="YYYY" style="width:64px">

  <span>Time :</span>
  <input id="btr_hh" maxlength="2" placeholder="HH" style="width:36px">
  <span>:</span>
  <input id="btr_min" maxlength="2" placeholder="MM" style="width:36px">
  <span>:</span>
  <input id="btr_sec" maxlength="2" placeholder="SS" style="width:36px">

</div>










<!-- =========================
     IGNORE MIN / SEC
     ========================= -->


<div style="text-align:center;font-weight:700">
  <label style="margin-right:14px">
    <input type="checkbox" id="ignoreMin" checked>
    Ignore Minutes
  </label>

  <label style="margin-right:14px">
    <input type="checkbox" id="ignoreSec" checked>
    Ignore Seconds
  </label>

  <label>
    <input type="checkbox" id="hideInputTable" checked onchange="toggleInputTable()">
    Hide Input Table
  </label>
  
 <label style="margin-left:14px">
  <input type="checkbox" id="levelThemeToggle" checked onchange="toggleLevelTheme()">
	Level Theme

</label>


  
</div>






<!-- =========================
     INPUT TABLE
     ========================= -->
<table id="inputTable">
<tr>
  <th>Planet / Lagna</th>
  <th>Sign</th>
  <th>Deg</th>
  <th>Min</th>
  <th>Sec</th>
</tr>
</table>

<!-- =========================
     ACTION BUTTONS
     ========================= -->
<div class="controls">
  <button onclick="saveJSON()">Save</button>
  <button onclick="loadJSON()">Load</button>
  <button onclick="clearAll()">Clear All</button>
  <button onclick="loadSwissJSON()">Load Swiss Ephemeris</button>
</div>

<script>
/* =========================================================
   CONSTANTS
   ========================================================= */
const signs=["","Aries","Taurus","Gemini","Cancer","Leo","Virgo",
             "Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];



/* =========================================================
   BTR REFERENCE HEADINGS (ANCHOR POINTS)
   ========================================================= */
const BTR_REFERENCE_SELECTOR = `
  h2[id^="table"],
  h2[id^="nav"],
  h3,
  h2
`;








function toggleInputTable(){
  const table = document.getElementById("inputTable");
  const cb = document.getElementById("hideInputTable");

  table.style.display = cb.checked ? "none" : "table";
}


function toggleLevelTheme(){
  if(document.getElementById("levelThemeToggle").checked){
    document.body.setAttribute("data-level-theme","on");
  }else{
    document.body.removeAttribute("data-level-theme");
  }
}

window.addEventListener("DOMContentLoaded", () => {
  toggleInputTable();
});


/* ===== APPLY LEVEL THEME BY DEFAULT ON LOAD ===== */
window.addEventListener("DOMContentLoaded", () => {
  if(document.getElementById("levelThemeToggle")?.checked){
    document.body.setAttribute("data-level-theme","on");
  }
});






const planets=[
  "Lagna",
  "Surya","Chandra","Mangala","Rahu",
  "Jupiter","Saturn","Budha","Ketu","Venus"
];






/* =========================================================
   CORE KUNDALI ENTITY REGISTRY
   (PLANETS + LAGNA + 1‚Äì12 CSL)
   ========================================================= */

const CORE_ENTITIES = [
  "Lagna",
  "Surya","Chandra","Mangala","Rahu",
  "Jupiter","Saturn","Budha","Ketu","Venus",
  ...Array.from({length:12},(_,i)=>(i+1)+"CSL")
];









/* =========================================================
   BUILD INPUT TABLE
   ========================================================= */
const table=document.getElementById("inputTable");

function buildRow(name){
  let r=table.insertRow();
  r.insertCell().innerHTML="<b>"+name+"</b>";

  let s=r.insertCell();
  let sel=document.createElement("select");
  sel.id=name+"_sign";
  signs.forEach(x=>{
    let o=document.createElement("option");
    o.value=o.text=x;
    sel.appendChild(o);
  });
  s.appendChild(sel);

  ["deg","min","sec"].forEach(k=>{
    let c=r.insertCell();
    let i=document.createElement("input");
    i.id=name+"_"+k;
    i.maxLength=2;
    i.oninput=()=>jumpLogic(i,k);
    c.appendChild(i);
  });
}

planets.forEach(buildRow);

/* =========================================================
   AUTO JUMP LOGIC
   ========================================================= */
   
   
   
function jumpLogic(inp,type){
  inp.value = inp.value.replace(/\D/g,"");

  let max = (type === "deg") ? 29 : 59;
  let val = inp.value === "" ? 0 : parseInt(inp.value,10);
  if(val > max) val = max;
  inp.value = val;

  if(inp.value.length < 2) return;

  let [p,k] = inp.id.split("_");
  let order = [...planets];
  let idx = order.indexOf(p);

  if(k === "deg"){
    if(!ignoreMin.checked){
      document.getElementById(p+"_min").focus();
    }else if(!ignoreSec.checked){
      document.getElementById(p+"_sec").focus();
    }else if(order[idx+1]){
      document.getElementById(order[idx+1]+"_deg").focus();
    }
  }

  else if(k === "min"){
    if(!ignoreSec.checked){
      document.getElementById(p+"_sec").focus();
    }else if(order[idx+1]){
      document.getElementById(order[idx+1]+"_deg").focus();
    }
  }

  else if(k === "sec"){
    if(order[idx+1]){
      document.getElementById(order[idx+1]+"_deg").focus();
    }
  }
}








/* =========================================================
   ARROW KEY INCREMENT / DECREMENT
   ========================================================= */
document.addEventListener("keydown", function(e){

  let el = document.activeElement;
  if(!el || el.tagName !== "INPUT") return;
  if(!el.id) return;

  if(!el.id.endsWith("_deg") &&
     !el.id.endsWith("_min") &&
     !el.id.endsWith("_sec")) return;

  let type = el.id.split("_")[1];
  let max = (type === "deg") ? 29 : 59;

  let val = parseInt(el.value || "0",10);

  if(e.key === "ArrowUp"){
    e.preventDefault();
    if(val < max) el.value = val + 1;
  }

  if(e.key === "ArrowDown"){
    e.preventDefault();
    if(val > 0) el.value = val - 1;
  }
});








/* =========================================================
   IGNORE MS TOGGLE
   ========================================================= */
function syncIgnoreFields(){

  planets.forEach(p=>{

    let min = document.getElementById(p+"_min");
    let sec = document.getElementById(p+"_sec");

    min.disabled = ignoreMin.checked;
    sec.disabled = ignoreSec.checked;

    if(ignoreMin.checked) min.value = "0";
    if(ignoreSec.checked) sec.value = "0";
  });
}

ignoreMin.onchange = ()=>{
  syncIgnoreFields();

  // üîì Only lock inputs if Swiss data is loaded
  if(window.__lastSwissData){
    lockPlanetInputs_BTR(true);
  }
};

ignoreSec.onchange = ()=>{
  syncIgnoreFields();

  // üîì Only lock inputs if Swiss data is loaded
  if(window.__lastSwissData){
    lockPlanetInputs_BTR(true);
  }
};

/* initial sync ‚Äî inputs remain editable */
syncIgnoreFields();
lockPlanetInputs_BTR(false);














/* =========================================================
   BTR PATCH 5 ‚Äî LOCK PLANET INPUTS
   ========================================================= */
function lockPlanetInputs_BTR(lock){

  planets.forEach(p=>{

    ["sign","deg","min","sec"].forEach(k=>{

      let el = document.getElementById(p + "_" + k);
      if(!el) return;

      /* Allow Ignore toggles to control min/sec */
      if(k === "min" && ignoreMin.checked) return;
      if(k === "sec" && ignoreSec.checked) return;

      el.disabled = lock;
    });
  });
}








/* =========================================================
   SAVE / LOAD / CLEAR
   ========================================================= */
function saveJSON(){
  let data={ personName:personName.value, entities:{} };
  planets.forEach(p=>{
    data.entities[p]={
      sign:document.getElementById(p+"_sign").value,
      deg:document.getElementById(p+"_deg").value,
      min:document.getElementById(p+"_min").value,
      sec:document.getElementById(p+"_sec").value
    };
  });
  let blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=(data.personName||"kundali")+".json";
  a.click();
}





function loadJSON(){
  let f=document.createElement("input");
  f.type="file"; 
  f.accept="application/json";

  f.onchange = e => {
    let r = new FileReader();

    r.onload = () => {
      let d = JSON.parse(r.result);

      personName.value = d.personName || "";

      Object.keys(d.entities || {}).forEach(p => {
        let o = d.entities[p];
        document.getElementById(p+"_sign").value = o.sign;
        document.getElementById(p+"_deg").value  = o.deg;
        document.getElementById(p+"_min").value  = o.min;
        document.getElementById(p+"_sec").value  = o.sec;
      });

      /* üî• FORCE FULL REDRAW AFTER LOAD */
      redrawAll();
    };

    r.readAsText(e.target.files[0]);
  };

  f.click();
}






function clearAll(){
  personName.value="";
  planets.forEach(p=>{
    document.getElementById(p+"_sign").selectedIndex=0;
    document.getElementById(p+"_deg").value="";
    document.getElementById(p+"_min").value="";
    document.getElementById(p+"_sec").value="";
  });
}



// ensure input table stays hidden on first load
window.addEventListener("DOMContentLoaded", () => {
  toggleInputTable();
});












</script>


<script>
function applyLevelTheme(){

  /* force repaint of Tables 2, 4, 5 */
  document
    .querySelectorAll(
      "#pllContainer tr[class^='lvl-'], \
       #cuspalPromiseContainer tr[class^='lvl-'], \
       #dynamicCuspalPromiseContainer tr[class^='lvl-']"
    )
    .forEach(tr => {
      tr.style.display = "none";
      tr.offsetHeight; // force reflow
      tr.style.display = "";
    });
}
</script>







<!-- =========================================================
     PART 2 : SOUTH INDIAN KUNDALI (CENTERED + PIVOT)
     ========================================================= -->

<hr>

<h2 id="nav2" style="text-align:center">SOUTH INDIAN KUNDALI</h2>

<!-- =========================
     PIVOT CONTROL
     ========================= -->
	 
	 
	 
	 
	 
	 
	 
<!-- =========================
     SOUTH INDIAN KUNDALI CONTROLS (SEPARATED ROWS)
     ========================= -->

<div class="pivotBar siControls">

  <!-- ===== ROW 1 : DROPDOWNS + COLOR PALETTE ===== -->
  <div class="siRow siRowTop">

    <span>Pivot :</span>
    <select id="kundaliPivot"></select>

    <span>Tara :</span>
    <select id="taraMode">
      <option value="SSL_OF_CHANDRA" selected>SSL OF Chandra</option>
      <option value="SL_OF_CHANDRA">SL OF Chandra</option>
      <option value="NL_OF_CHANDRA">NL OF Chandra</option>
      <option value="Star Lord">Star Lord</option>
      <option value="Planet">Planet</option>
      <option value="Surya">Surya</option>
      <option value="Chandra">Chandra</option>
      <option value="Mangala">Mangala</option>
      <option value="Rahu">Rahu</option>
      <option value="Jupiter">Jupiter</option>
      <option value="Saturn">Saturn</option>
      <option value="Budha">Budha</option>
      <option value="Ketu">Ketu</option>
      <option value="Venus">Venus</option>
    </select>
	
	
	
	<span>Lagna :</span>
	<select id="lagnaOverride">
	  <option value="Aries">Aries</option>
	  <option value="Taurus">Taurus</option>
	  <option value="Gemini">Gemini</option>
	  <option value="Cancer">Cancer</option>
	  <option value="Leo">Leo</option>
	  <option value="Virgo">Virgo</option>
	  <option value="Libra">Libra</option>
	  <option value="Scorpio">Scorpio</option>
	  <option value="Sagittarius">Sagittarius</option>
	  <option value="Capricorn">Capricorn</option>
	  <option value="Aquarius">Aquarius</option>
	  <option value="Pisces">Pisces</option>
	</select>





    <!-- üîÆ COLOR PALETTE -->
    <div id="colorPalette">
      <div class="colorBox purple active" data-color="purple" title="Royal Purple"></div>
      <div class="colorBox maroon" data-color="maroon" title="Blood Maroon"></div>
    </div>

  </div>

  <!-- ===== ROW 2 : ALL CHECKBOXES (SINGLE ROW) ===== -->
  <div class="siRow siRowBottom">

    <label>
      <input type="checkbox" id="sign2signMode">
      Sign-to-Sign
    </label>

    <label>
      <input type="checkbox" id="kpMode">
      KP (0¬∞)
    </label>

    <label>
      <input type="checkbox" id="vedicMode" checked>
      Vedic (15¬∞)
    </label>

    <label>
      <input type="checkbox" id="showCuspMode">
      Cusp
    </label>

    <label>
      <input type="checkbox" id="westAspMode" checked>
      West Asp
    </label>

    <label>
      <input type="checkbox" id="trueNodeMode" checked>
      True Node
    </label>

  </div>

</div>






</div>





<!-- =========================
     KUNDALI WRAPPER (CENTER)
     ========================= -->
<div style="display:flex;justify-content:center">
  <div id="siKundali"></div>
</div>











<script>

let USE_TRUE_NODE =
  document.getElementById("trueNodeMode")?.checked || false;

// üîí RAW SWISS NODE STORAGE (ABSOLUTE, NEVER SHIFTED)
window.__rawRahuAbs = null;
window.__rawKetuAbs = null;
window.__rawRahuTrueAbs = null;
window.__rawKetuTrueAbs = null;



/* =========================================================
   SOUTH INDIAN SIGN LAYOUT (FIXED)
   (MATCHES YOUR ORIGINAL PROJECT)
   ========================================================= */
const SI_SIGNS = [
  "Pisces","Aries","Taurus","Gemini",
  "Aquarius","","","Cancer",
  "Capricorn","","","Leo",
  "Sagittarius","Scorpio","Libra","Virgo"
];










/* =========================================================
   BUILD PIVOT DROPDOWN (PLANETS + CSL)
   ========================================================= */
(function(){
  let sel = document.getElementById("kundaliPivot");
  sel.innerHTML = "";

  /* ---------- PLANETS + LAGNA (FIRST ROUND) ---------- */
  const PLANET_LIST = [
    "Lagna","Surya","Chandra","Mangala","Rahu",
    "Jupiter","Saturn","Budha","Ketu","Venus"
  ];

  PLANET_LIST.forEach(p=>{
    let o = document.createElement("option");
    o.value = p;
    o.text  = p;
    sel.appendChild(o);
  });

  /* ---------- PLANETS REPEATED AGAIN (SECOND ROUND) ---------- */
  PLANET_LIST.slice(1).forEach(p=>{   // skip Lagna in repeat
    let o = document.createElement("option");
    o.value = p + "_2";              // internal unique key
    o.text  = p;                     // visually same label
    sel.appendChild(o);
  });

  /* ---------- CSL PIVOTS ---------- */
  for(let i = 1; i <= 12; i++){
    let o = document.createElement("option");
    o.value = i + "CSL";
    o.text  = i + " CSL";
    sel.appendChild(o);
  }

  sel.value = "Lagna";
})();


/* =========================================================
   INIT SOUTH INDIAN KUNDALI
   ========================================================= */
function initSIKundali(){
  let g=document.getElementById("siKundali");
  g.innerHTML="";
  SI_SIGNS.forEach(s=>{
    if(s===""){
      g.innerHTML+=`<div class="siCell siCenter"></div>`;
    }else{
      g.innerHTML+=`
      <div class="siCell" data-sign="${s}">
        <div class="siHouse"></div>
        <div class="siList"></div>
        <div class="siSign">${s}</div>
      </div>`;
    }
  });
}





function formatDegMinSec(abs){

  abs = ((abs % 360) + 360) % 360;

  let degFloat = abs % 30;
  let deg = Math.floor(degFloat);
  let minFloat = (degFloat - deg) * 60;
  let min = Math.floor(minFloat);
  let sec = Math.round((minFloat - min) * 60);

  if(sec === 60){ sec = 0; min++; }
  if(min === 60){ min = 0; deg++; }

  return `${deg}¬∞${String(min).padStart(2,"0")}‚Ä≤${String(sec).padStart(2,"0")}‚Ä≥`;
}







/* =========================================================
   SINGLE SOURCE ABSOLUTE DEGREE
   BTR ‚Üí SWISS ‚Üí UI (FALLBACK)
   ========================================================= */
function getAbsDeg(entity){

  /* =========================
     1Ô∏è‚É£ BTR DYNAMIC REGISTRY
     ========================= */
  // üîí BTR ABSOLUTE ‚Äî EXCEPT RAHU / KETU
	if(
	  window.__btrAbs &&
	  typeof window.__btrAbs[entity] === "number" &&
	  entity !== "Rahu" &&
	  entity !== "Ketu"
	){
	  return ((window.__btrAbs[entity] % 360) + 360) % 360;
	}


  /* =========================
     2Ô∏è‚É£ CUSP ENTITY (STATIC SWISS)
     ========================= */
  if(entity.endsWith("CSL")){
    const data = window.__lastSwissData;
    if(!data || !data.cusps) return null;

    let n = parseInt(entity,10);
    let abs = data.cusps[String(n)];
    if(typeof abs !== "number") return null;

    return ((abs % 360) + 360) % 360;
  }

  /* =========================
     3Ô∏è‚É£ TRUE / MEAN NODE (RAW)
     ========================= */


	  if(entity === "Rahu" || entity === "Ketu"){

    let abs = null;

    // 1Ô∏è‚É£ Swiss / BTR raw node (highest priority)
    if(entity === "Rahu"){
      abs = USE_TRUE_NODE
        ? window.__rawRahuTrueAbs
        : window.__rawRahuAbs;
    }

    if(entity === "Ketu"){
      abs = USE_TRUE_NODE
        ? window.__rawKetuTrueAbs
        : window.__rawKetuAbs;
    }

    // 2Ô∏è‚É£ If Swiss NOT loaded ‚Üí FALL BACK TO MANUAL INPUT
    if(typeof abs !== "number"){

      let signEl = document.getElementById(entity + "_sign");
      if(!signEl) return null;

      let signIndex = signs.indexOf(signEl.value);
      if(signIndex <= 0) return null;

      let deg = +document.getElementById(entity + "_deg").value || 0;
      let min = +document.getElementById(entity + "_min").value || 0;
      let sec = +document.getElementById(entity + "_sec").value || 0;

      return (signIndex - 1) * 30 + deg + min/60 + sec/3600;
    }

    return ((abs % 360) + 360) % 360;
  }











  /* =========================
     4Ô∏è‚É£ UI FALLBACK (MANUAL)
     ========================= */
  let signEl = document.getElementById(entity+"_sign");
  if(!signEl) return null;

  let signIndex = signs.indexOf(signEl.value);
  if(signIndex <= 0) return null;

  let deg = +document.getElementById(entity+"_deg").value || 0;
  let min = +document.getElementById(entity+"_min").value || 0;
  let sec = +document.getElementById(entity+"_sec").value || 0;

  return (signIndex - 1) * 30 + deg + min/60 + sec/3600;
}















function getPivotAbs(entity){

  // normalize duplicate pivots (Surya_2 ‚Üí Surya)
  let base = entity.split("_")[0];

  return getAbsDeg(base);
}












function getPivotSign(entity){

  // normalize duplicate pivots (Surya_2 ‚Üí Surya)
  let base = entity.split("_")[0];

  let abs = getAbsDeg(base);
  if(abs === null) return "";

  let signIndex = Math.floor(abs / 30);
  return signs[signIndex + 1] || "";
}










function getGlobalOffset(){

  if(!kpMode.checked && !vedicMode.checked){
    return 0;
  }

  let pivot = document.getElementById("kundaliPivot").value;
  let pivotAbs = getPivotAbs(pivot);
  if(pivotAbs === null) return 0;

  let pivotDeg = pivotAbs % 30;

  // KP ‚Üí pivot becomes 0¬∞
  if(kpMode.checked){
    return -pivotDeg;
  }

  // Vedic ‚Üí pivot becomes 15¬∞
  if(vedicMode.checked){
    return 15 - pivotDeg;
  }

  return 0;
}







/* =========================================
   KUNDALI RASI SELECTION MEMORY
   (MULTI SELECT ‚Äì UNTIL RELOAD)
   ========================================= */
window.__selectedRasis = new Set();








/* =========================================================
   DRAW SOUTH INDIAN KUNDALI (PIVOT BASED)
   ========================================================= */
function drawSIKundali(){

  initSIKundali();


/* üî• HARD RESET ALL SIGN CONTENT (PREVENT DUPLICATION) */
document
  .querySelectorAll("#siKundali .siList")
  .forEach(l => l.innerHTML = "");



  let pivot = document.getElementById("kundaliPivot").value;
  let pivotSign = getPivotSign(pivot);
  let pivotAbs  = getPivotAbs(pivot);

  if(!pivotSign || pivotAbs === null) return;






/* =========================
   ASSIGN HOUSE NUMBERS (CORRECT SOUTH INDIAN CYCLIC)
   ========================= */

/* Zodiac order for house calculation */
const ZODIAC_ORDER = [
  "Aries","Taurus","Gemini","Cancer",
  "Leo","Virgo","Libra","Scorpio",
  "Sagittarius","Capricorn","Aquarius","Pisces"
];

let cells = [...document.querySelectorAll("#siKundali .siCell[data-sign]")];


/* =========================================
   RESTORE + TOGGLE RASI HIGHLIGHT (MULTI)
   ========================================= */
cells.forEach(cell => {

  let sign = cell.dataset.sign;

  /* restore after redraw */
  if(window.__selectedRasis.has(sign)){
    cell.classList.add("selectedRasi");
  }

  /* click toggle */
  cell.addEventListener("click", () => {

    if(window.__selectedRasis.has(sign)){
      window.__selectedRasis.delete(sign);
      cell.classList.remove("selectedRasi");
    }else{
      window.__selectedRasis.add(sign);
      cell.classList.add("selectedRasi");
    }

  });

});







/* find Lagna sign index in zodiac */
let lagnaZodiacIndex = ZODIAC_ORDER.indexOf(pivotSign);
if(lagnaZodiacIndex === -1) return;

/* assign houses cyclically */
cells.forEach(cell => {

  let sign = cell.dataset.sign;
  let signZodiacIndex = ZODIAC_ORDER.indexOf(sign);
  if(signZodiacIndex === -1) return;

  let house =
    (signZodiacIndex - lagnaZodiacIndex + 12) % 12 + 1;

  cell.querySelector(".siHouse").textContent = house;
});









/* ===== FINAL LAGNA-BASED DEGREE SHIFT (SINGLE SOURCE) ===== */

let offset = getGlobalOffset();










/* ===== SIGN-WISE ORDERED PLANET PLACEMENT ===== */

let buckets = {};















/* 1Ô∏è‚É£ COLLECT PLANETS INTO SIGN BUCKETS */
[
 "Lagna","Surya","Chandra","Mangala","Rahu",
 "Jupiter","Saturn","Budha","Ketu","Venus"
].forEach(label => {




/* 1Ô∏è‚É£B COLLECT CUSPS AS PLANET-EQUIVALENTS */
if(document.getElementById("showCuspMode").checked){

  const data = window.__lastSwissData;
  const cusps = data?.cusps || {};

  Object.keys(cusps)
    .map(Number)
    .sort((a,b)=>a-b)
    .forEach(c => {

      let abs = cusps[String(c)];
      if(typeof abs !== "number") return;

      let shifted = abs + offset;
      shifted = ((shifted % 360) + 360) % 360;

      let signIndex = Math.floor(shifted / 30);
      let sign = signs[signIndex + 1];
      if(!sign) return;

      if(!buckets[sign]) buckets[sign] = [];



	/* ‚ùå PREVENT DUPLICATE CUSP INSERTION */
		if(
		  !buckets[sign].some(x => x.type === "cusp" && x.label === `${c}C`)
		){
		  buckets[sign].push({
			type: "cusp",
			label: `${c}C`,
			deg: shifted % 30,
			abs: shifted,
			signIndex,
			text: `${c}C ${formatDegMinSec(shifted)}`
		  });
		}

	  
	  
    });
}





  let rawAbs = getAbsDeg(label);
  if(rawAbs === null) return;

  let shiftedAbs = rawAbs + offset;
  shiftedAbs = ((shiftedAbs % 360) + 360) % 360;

  let signIndex = Math.floor(shiftedAbs / 30);
  let sign = signs[signIndex + 1];
  if(!sign) return;

  let degInSign;
  if(label === "Lagna" && kpMode.checked){
    degInSign = 0;
  }else if(label === "Lagna" && vedicMode.checked){
    degInSign = 15;
  }else{
    degInSign = Math.floor(shiftedAbs % 30);
  }

  if(!buckets[sign]){
    buckets[sign] = [];
  }

  buckets[sign].push({
    label,
    deg: degInSign,
    signIndex
  });
});

/* 2Ô∏è‚É£ SORT + RENDER */
Object.keys(buckets).forEach(sign => {

  let list = buckets[sign];
  let signIndex = list[0].signIndex;

  /* Aries ‚Üí Virgo : ASCENDING */
  if(signIndex <= 5){
    list.sort((a,b) => a.deg - b.deg);
  }
  /* Libra ‚Üí Pisces : DESCENDING */
  else{
    list.sort((a,b) => b.deg - a.deg);
  }

  let cell = cells.find(c => c.dataset.sign === sign);
  if(!cell) return;

  
  
  
  
  
list.forEach(p => {
  let d = document.createElement("div");
  d.className = (p.type === "cusp") ? "siCusp" : "";
  
  
  
	  let label = p.label;

	if(isRetroPlanet(p.label)){
	  label += " (R)";
	}
	
	
	
	if(isStarExchangePlanet(p.label)){
	  label += " #";
	}


	d.textContent =
	  p.text ?? `${label} ${Math.floor(p.deg)}¬∞`;

	  
  
  
  cell.querySelector(".siList").appendChild(d);
});


  
  
});

   
}









/* =========================================================
   AUTO REFRESH HOOKS
   ========================================================= */
document.getElementById("kundaliPivot").onchange = drawSIKundali;
document.getElementById("showCuspMode")
  ?.addEventListener("change", drawSIKundali);


["Lagna","Surya","Chandra","Mangala","Rahu",
 "Jupiter","Saturn","Budha","Ketu","Venus"].forEach(p=>{
  ["sign","deg","min","sec"].forEach(k=>{
    let el=document.getElementById(p+"_"+k);
    if(el){
      el.addEventListener("change", drawSIKundali);
      el.addEventListener("input", drawSIKundali);
    }
  });
});

/* Initial draw */
drawSIKundali();
</script>











<!-- =========================================================
     PART 3 : COUNTER TABLE (FORWARD + RETRO)
     ========================================================= -->

<hr>


<h2 id="table1" style="text-align:center">
TABLE 1 -  PLANET COUNTER TABLE
</h2>


<div style="width:100%">
  <table id="counterTable">
<tr>
 <th>Planet</th>
 <th>Forward</th>
 <th>Lordship</th>
 <th>Summation</th>
 <th>Tara</th>
 <th>Degree Difference</th>
 <th>West Aspect</th>
 <th>Retro</th>
 <th>State</th>
</tr>

</table>


<div style="
  margin-top:32px;
  margin-bottom:14px;
  text-align:center;
  font-size:17px;
  font-weight:900;
  color:#fef3c7;
  letter-spacing:0.9px;
">
 

  <span style="margin-left:26px">$</span> = UnTenanted
  <span style="margin-left:40px">%</span> = Own Star / Own Sub
  <span style="margin-left:40px">(R)</span> = Retrograde
  <span style="margin-left:40px">#</span> = Star-Lord Exchange
</div>




</div>

<script>










/* =========================================================
   HOUSE FROM PIVOT (GENERAL KUNDALI LOGIC)
   ========================================================= */







function getHouseFromPivot(entity){

  // normalize duplicate pivot (Surya_2 ‚Üí Surya)
  let pivot =
    document.getElementById("kundaliPivot").value.split("_")[0];

  let pivotAbs = getAbsDeg(pivot);
  let entAbs   = getAbsDeg(entity);

  if(pivotAbs === null || entAbs === null) return 1;

  /* =========================================
     MODE 1 : SIGN-TO-SIGN
     ========================================= */
  if(sign2signMode.checked){
    let pSign = Math.floor(pivotAbs / 30);
    let eSign = Math.floor(entAbs / 30);
    let house = eSign - pSign + 1;
    if(house <= 0) house += 12;
    return house;
  }

  /* =========================================
     MODE 2 : KP (0¬∞ BHAVA)
     ========================================= */
  if(kpMode.checked){

    let pivotDeg = pivotAbs % 30;
    let offset   = -pivotDeg;

    let p = (pivotAbs + offset + 360) % 360;
    let e = (entAbs   + offset + 360) % 360;

    let diff = e - p;
    if(diff < 0) diff += 360;

    let house = Math.floor(diff / 30) + 1;
    if(house > 12) house -= 12;
    return house;
  }

  /* =========================================
     MODE 3 : VEDIC (¬±15¬∞)
     ========================================= */
  if(vedicMode.checked){

    let bhavaStart = pivotAbs - 15;
    bhavaStart = ((bhavaStart % 360) + 360) % 360;

    let diff = entAbs - bhavaStart;
    diff = ((diff % 360) + 360) % 360;

    let house = Math.floor(diff / 30) + 1;
    if(house > 12) house -= 12;
    return house;
  }

  return 1;
}




















/* =========================================
   COUNTER TABLE ROW SELECTION MEMORY
   (MULTI SELECT ‚Äì UNTIL RELOAD)
   ========================================= */
window.__selectedCounterRows = {};










/* =========================================
   DISPOSITORS FOR RAHU / KETU
   ========================================= */
function getDispositor(planet){

  let abs = getAbsDeg(planet);
  if(abs === null) return "";

  let signIndex = Math.floor(abs / 30);
  let sign = signs[signIndex + 1];

  return SIGN_LORDS[sign] || "";
}





/* =========================================
   ABS DEGREE DIFFERENCE FROM PIVOT
   ========================================= */



		function getDegreeDifference(entity){

		  let pivot = document.getElementById("kundaliPivot").value;

		  let pAbs = getPivotAbs(pivot);
		  let eAbs = getAbsDeg(entity);
		  if(pAbs===null || eAbs===null) return "";

		  let diff = eAbs - pAbs;
		  if(diff < 0) diff += 360;

		  /* WESTERN ASPECT NORMALIZATION */
		  if(westAspMode.checked && diff > 180){
			diff = diff - 180;
		  }

		  return diff;
		}



















/* =========================================
   WESTERN ASPECT DEFINITIONS
   ========================================= */
const WESTERN_ASPECTS = [
  { d:0,   o:8, n:"Conjunction" },
  { d:18,  o:1, n:"Vigintile" },
  { d:36,  o:1, n:"Decile" },
  { d:40,  o:1.5, n:"Novile" },
  { d:45,  o:3, n:"Semi-Square" },
  { d:60,  o:6, n:"Sextile" },
  { d:72,  o:2, n:"Quintile" },
  { d:90,  o:8, n:"Square" },
  { d:120, o:8, n:"Trine" },
  { d:135, o:3, n:"Sesqui-Square" },
  { d:144, o:2, n:"Bi-Quintile" },
  { d:150, o:4, n:"Quincunx" },
  { d:180, o:8, n:"Opposition" }
];

function getWestAspect(diff){
  for(let a of WESTERN_ASPECTS){
    if(Math.abs(diff - a.d) <= a.o){
      return a.n;
    }
  }
  return "";
}












const SIGN_LORDS = {
  Aries:"Mangala",
  Taurus:"Venus",
  Gemini:"Budha",
  Cancer:"Chandra",
  Leo:"Surya",
  Virgo:"Budha",
  Libra:"Venus",
  Scorpio:"Mangala",
  Sagittarius:"Jupiter",
  Capricorn:"Saturn",
  Aquarius:"Saturn",
  Pisces:"Jupiter"
};


















function getHouseLordships(planet){

  // 1Ô∏è‚É£ Get actual Lagna absolute degree
  let pivot = document.getElementById("kundaliPivot").value;
  let pivotAbs = getPivotAbs(pivot);
  if(pivotAbs === null) return "";

  // 2Ô∏è‚É£ Zodiac signs in order
  const ZODIAC = [
    "Aries","Taurus","Gemini","Cancer",
    "Leo","Virgo","Libra","Scorpio",
    "Sagittarius","Capricorn","Aquarius","Pisces"
  ];



// 3Ô∏è‚É£ DEFAULT Lagna sign from pivot (LORDSHIP ONLY)
let lagnaSignIndex = Math.floor(pivotAbs / 30);
let lagnaDegInSign = pivotAbs % 30;

// üî• APPLY 15¬∞ RULE ‚Äî ONLY FOR LORDSHIP
if(lagnaDegInSign >= 15){
  lagnaSignIndex = (lagnaSignIndex + 1) % 12;
}





  // 4Ô∏è‚É£ üî• MANUAL LAGNA OVERRIDE (ONLY FOR LORDSHIP)
  const override = document.getElementById("lagnaOverride")?.value;
  if(override){
    const idx = ZODIAC.indexOf(override);
    if(idx !== -1){
      lagnaSignIndex = idx;
    }
  }

  // 5Ô∏è‚É£ Calculate lordship houses
  let houses = [];

  for(let i = 0; i < 12; i++){
    let sign = ZODIAC[(lagnaSignIndex + i) % 12];
    let lord = SIGN_LORDS[sign];

    if(lord === planet){
      houses.push(i + 1);
    }
  }

  return houses.join(",");
}













function getRahuKetuHouseLordships(node){

  /* 1Ô∏è‚É£ Node sign */
  
  let nodeSign = signs[Math.floor(getAbsDeg(node) / 30) + 1];
  if(!nodeSign) return "";

  /* 2Ô∏è‚É£ Dispositor planet */
  let dispositor = SIGN_LORDS[nodeSign];
  if(!dispositor) return "";

  let houses = [];

  /* 3Ô∏è‚É£ Houses ruled by dispositor (SIGN LORDSHIPS) */
  let ruled = getHouseLordships(dispositor)
    .split(",")
    .filter(x => x !== "")
    .map(Number);

  houses.push(...ruled);

  /* 4Ô∏è‚É£ House where dispositor is PLACED */
  let placedHouse = getHouseFromPivot(dispositor);
  if(placedHouse){
    houses.push(placedHouse);
  }

  /* 5Ô∏è‚É£ Unique + sorted */
  houses = [...new Set(houses)].sort((a,b)=>a-b);

  return houses.join(",");
}







/* =========================================================
   BUILD COUNTER TABLE
   ========================================================= */
function buildCounterTable(){

  let table = document.getElementById("counterTable");

  /* clear old rows */
  while(table.rows.length > 1){
    table.deleteRow(1);
  }




 
let pivot = document.getElementById("kundaliPivot").value;

const BASE_PLANET_ORDER = [
  "Surya",
  "Chandra",
  "Mangala",
  "Rahu",
  "Jupiter",
  "Saturn",
  "Budha",
  "Ketu",
  "Venus"
];

let order;

/* Pivot = Lagna ‚Üí keep Lagna on top */
if(pivot === "Lagna"){
  order = ["Lagna", ...BASE_PLANET_ORDER];
}

/* üî• PLANET PIVOT */
else if(BASE_PLANET_ORDER.includes(pivot)){
  let idx = BASE_PLANET_ORDER.indexOf(pivot);
  order = [
    ...BASE_PLANET_ORDER.slice(idx),
    ...BASE_PLANET_ORDER.slice(0, idx)
  ];
}

/* üî• CSL PIVOT ‚Üí DO NOT ROTATE PLANET ORDER */
else{
  order = ["Lagna", ...BASE_PLANET_ORDER];
}





 
 
 
 

  /* remove duplicates, preserve order */
  order = [...new Set(order)];

  order.forEach(p=>{

    let fwd, ret;

    if(p === document.getElementById("kundaliPivot").value){
      fwd = 1;
      ret = 1;
    }else{
      fwd = getHouseFromPivot(p);
	 ret = getRetroHouseFromPivot(p);

    }

    let r = table.insertRow();

/* restore selection + color after redraw */
if(window.__selectedCounterRows[p]){
  r.classList.add("selectedRow");
  r.setAttribute("data-color", window.__selectedCounterRows[p]);
}





		r.addEventListener("click", ()=>{

		  if(window.__selectedCounterRows[p]){
			delete window.__selectedCounterRows[p];
			r.classList.remove("selectedRow");
			r.removeAttribute("data-color");
		  }else{
			const activeColor =
			  document.querySelector("#colorPalette .colorBox.active")
				?.dataset.color || "purple";

			window.__selectedCounterRows[p] = activeColor;
			r.classList.add("selectedRow");
			r.setAttribute("data-color", activeColor);
		  }

		});







		/* LORDSHIP (HOUSE NUMBERS) */
		let lordships;
		if(p === "Rahu" || p === "Ketu"){
		  lordships = getRahuKetuHouseLordships(p);
		}else{
		  lordships = getHouseLordships(p);
		}

		/* DEGREE DIFFERENCE + ASPECT */
		let diff = getDegreeDifference(p);
		let aspect = diff !== "" ? getWestAspect(diff) : "";





		/* INSERT EXACTLY 6 CELLS (MATCH HEADER) */
		let state = getPlanetState(p);

		/* Planet name with TENANTED indicator */
		let planetLabel = p;

		if(isRetroPlanet(p)){
		  planetLabel += " (R)";
		}

		if(isTenantedPlanet(p)){
		  planetLabel += " $";
		}
		
		if(isInOwnStarOrSub(p)){
		  planetLabel += " %";
		}
		
		if(isStarExchangePlanet(p)){
		  planetLabel += " #";
		}



		r.insertCell().innerHTML = `<b>${planetLabel}</b>`;


		// Forward
		r.insertCell().textContent = fwd;

		// Lordship
		r.insertCell().textContent = lordships;

		// Summation (Forward + Lordship)
		r.insertCell().textContent =
		  getCounterSummation(fwd, lordships);

		// Tara (ONLY this planet, based on selected Tara mode)
		r.insertCell().textContent =
		  getTaraLabel(p, p);

		// Degree Difference
		r.insertCell().textContent =
		  diff !== "" ? diff.toFixed(2) + "¬∞" : "";

		// West Aspect
		r.insertCell().textContent = aspect;

		// Retro
		r.insertCell().textContent = ret;

		// State
		r.insertCell().textContent = state;










  });
}

/* =========================================================
   AUTO REFRESH HOOKS
   ========================================================= */
document.getElementById("kundaliPivot")
  .addEventListener("change", () => {

    /* üî• RESET lagna override when pivot changes */
    const lagnaSel = document.getElementById("lagnaOverride");
    if(lagnaSel){
      delete lagnaSel.dataset.userTouched;
    }

    /* full redraw so Lagna re-syncs correctly */
    redrawAll();
  });


/* üî• TARA MODE ‚Üí TABLE 1 SYNC (FIX) */
document.getElementById("taraMode")
  ?.addEventListener("change", buildCounterTable);








document.getElementById("lagnaOverride")
  ?.addEventListener("change", e => {

    // üîí user explicitly changed Lagna
    e.target.dataset.userTouched = "1";

    buildCounterTable();
    redrawPLL();
  });





["Lagna","Surya","Chandra","Mangala","Rahu",
 "Jupiter","Saturn","Budha","Ketu","Venus"].forEach(p=>{
  ["sign","deg","min","sec"].forEach(k=>{
    let el=document.getElementById(p+"_"+k);
    if(el){
      el.addEventListener("change", buildCounterTable);
      el.addEventListener("input", buildCounterTable);
    }
  });
});

/* initial draw */
buildCounterTable();
</script>









<script>
/* =========================================================
   PLANET SIGN STATE LOGIC (LOCKED RULESET)
   ========================================================= */

const UCCHA = {
  Surya:["Aries"],
  Chandra:["Taurus"],
  Mangala:["Capricorn"],
  Budha:["Virgo"],
  Jupiter:["Cancer"],
  Venus:["Pisces"],
  Saturn:["Libra"],
  Rahu:["Taurus","Gemini"],
  Ketu:["Scorpio","Sagittarius"]
};

const NEECHA = {
  Surya:["Libra"],
  Chandra:["Scorpio"],
  Mangala:["Cancer"],
  Budha:["Pisces"],
  Jupiter:["Capricorn"],
  Venus:["Virgo"],
  Saturn:["Aries"],
  Rahu:["Scorpio","Sagittarius"],
  Ketu:["Taurus","Gemini"]
};

const OWN_SIGNS = {
  Surya:["Leo"],
  Chandra:["Cancer"],
  Mangala:["Aries","Scorpio"],
  Budha:["Gemini","Virgo"],
  Jupiter:["Sagittarius","Pisces"],
  Venus:["Taurus","Libra"],
  Saturn:["Capricorn","Aquarius"],
  Rahu:["Aquarius"],
  Ketu:["Sagittarius"]
};

/* FRIENDSHIP TABLES */
const FRIENDS = {
  Surya:["Chandra","Mangala","Jupiter"],
  Chandra:["Surya","Budha"],
  Mangala:["Surya","Chandra","Jupiter"],
  Budha:["Surya","Venus"],
  Jupiter:["Surya","Chandra","Mangala"],
  Venus:["Budha","Saturn"],
  Saturn:["Budha","Venus"],

  Rahu:["Venus","Budha","Saturn"],
  Ketu:["Jupiter","Mangala"]
};

const NEUTRALS = {
  Surya:["Budha"],
  Chandra:["Mangala"],
  Mangala:["Venus","Saturn"],
  Budha:["Mangala","Jupiter","Saturn"],
  Jupiter:["Saturn"],
  Venus:["Mangala","Jupiter"],
  Saturn:["Jupiter"],

  Rahu:["Surya"],
  Ketu:["Venus","Budha","Surya"]
};

const ENEMIES = {
  Surya:["Venus","Saturn"],
  Chandra:["Saturn","Venus","Jupiter"],
  Mangala:["Budha"],
  Budha:["Chandra"],
  Jupiter:["Budha","Venus"],
  Venus:["Surya","Chandra"],
  Saturn:["Surya","Chandra","Mangala"],

  Rahu:["Jupiter","Mangala","Chandra","Ketu"],
  Ketu:["Saturn","Rahu","Chandra"]
};

/* =========================================================
   GET PLANET STATE BY SIGN
   ========================================================= */
   
   
   
function getPlanetState(planet){

  /* üî• BTR-AWARE SIGN RESOLUTION */
  let abs = getAbsDeg(planet);
  if(abs === null) return "";

  let signIndex = Math.floor(abs / 30);
  let sign = signs[signIndex + 1];
  if(!sign) return "";

  if(UCCHA[planet]?.includes(sign)) return "Uccha";
  if(NEECHA[planet]?.includes(sign)) return "Neecha";
  if(OWN_SIGNS[planet]?.includes(sign)) return "Own";

  let lord = SIGN_LORDS[sign];
  if(FRIENDS[planet]?.includes(lord)) return "Friend";
  if(NEUTRALS[planet]?.includes(lord)) return "Neutral";
  if(ENEMIES[planet]?.includes(lord)) return "Enemy";

  return "";
}




</script>

















<script>
/* =========================================================
   HOUSE FROM PIVOT ‚Äî RETRO (BHAVA-CORRECT)
   EXACT MIRROR OF FORWARD LOGIC
   ========================================================= */
   
   
   
   
   function getRetroHouseFromPivot(entity){

  let pivot = document.getElementById("kundaliPivot").value;

  let pivotAbs = getAbsDeg(pivot);
  let entAbs   = getAbsDeg(entity);

  if(pivotAbs === null || entAbs === null) return 1;

  /* =========================================
     MODE 1 : SIGN-TO-SIGN (UNCHANGED)
     ========================================= */
  if(sign2signMode.checked){
    let pSign = Math.floor(pivotAbs / 30);
    let eSign = Math.floor(entAbs / 30);

    let house = pSign - eSign + 1;
    if(house <= 0) house += 12;

    return house;
  }

  /* =========================================
     MODE 2 : KP (PURE DEGREE BACKWARD)
     IGNORE SIGNS COMPLETELY
     ========================================= */
  if(kpMode.checked){

    let diff = pivotAbs - entAbs;
    if(diff < 0) diff += 360;

    let house = Math.floor(diff / 30) + 1;
    if(house > 12) house -= 12;

    return house;
  }

  /* =========================================
     MODE 3 : VEDIC (PURE DEGREE BACKWARD)
     PIVOT DEGREE IS MIDPOINT
     ========================================= */
  if(vedicMode.checked){

    let diff = pivotAbs - entAbs;
    if(diff < 0) diff += 360;

    let house = Math.floor(diff / 30) + 1;
    if(house > 12) house -= 12;

    return house;
  }

  return 1;
}







</script>


















<script>
/* =========================================================
   MODE EXCLUSIVITY
   ========================================================= */

function enforceMode(mode){

  sign2signMode.checked = false;
  kpMode.checked = false;
  vedicMode.checked = false;

  if(mode === "sign") sign2signMode.checked = true;
  if(mode === "kp") kpMode.checked = true;
  if(mode === "vedic") vedicMode.checked = true;

  redrawAll();
  


}

sign2signMode.onchange = ()=> enforceMode("sign");
kpMode.onchange        = ()=> enforceMode("kp");
vedicMode.onchange     = ()=> enforceMode("vedic");

/* default */
enforceMode("kp");


sign2signMode.addEventListener("change",()=>{
  if(sign2signMode.checked) enforceMode("sign");
});

kpMode.addEventListener("change",()=>{
  if(kpMode.checked) enforceMode("kp");
});

vedicMode.addEventListener("change",()=>{
  if(vedicMode.checked) enforceMode("vedic");
});




/* =========================================================
   GET PIVOT REFERENCE DEGREE
   KP  ‚Üí 0¬∞
   VED ‚Üí 15¬∞
   NONE ‚Üí ACTUAL DEGREE
   ========================================================= */
function getPivotReferenceAbs(pivot){

  let sign = document.getElementById(pivot+"_sign").value;
  let signIndex = signs.indexOf(sign);
  if(signIndex <= 0) return null;

  /* KP MODE */
  if(kpMode.checked){
    return (signIndex - 1) * 30;
  }

  /* VEDIC MODE */
  if(vedicMode.checked){
    return (signIndex - 1) * 30 + 15;
  }

  /* NORMAL MODE */
  return getAbsDeg(pivot);
}






























/* =========================================================
   GLOBAL REDRAW
   ========================================================= */
function redrawAll(){
  drawSIKundali();
  
  
		/* üî• Sync Lagna Override with LORDSHIP Lagna (15¬∞ RULE ONLY) */
		(function(){
		  const sel = document.getElementById("lagnaOverride");
		  if(!sel) return;

		  // do not override manual choice
		  if(sel.dataset.userTouched) return;

		  const pivot = document.getElementById("kundaliPivot")?.value;
		  if(!pivot) return;

		  const pivotAbs = getPivotAbs(pivot);
		  if(pivotAbs == null) return;

		  let signIndex = Math.floor(pivotAbs / 30);
		  let degInSign = pivotAbs % 30;

		  // üî• APPLY 15¬∞ RULE ‚Äî ONLY FOR LORDSHIP UI
		  if(degInSign >= 15){
			signIndex = (signIndex + 1) % 12;
		  }

		  sel.value = signs[signIndex + 1];
		})();



  
  buildCounterTable();
  redrawPLL();
  buildCuspalTable();
  buildCuspalPromiseReader();   // ‚úÖ TABLE 4 LINKED
	buildDynamicCuspalPromiseReader(); // ‚úÖ TABLE 5
}




/* =========================================================
   FLOATING NAVIGATION SCROLL (TABLE 1‚Äì5)
   ========================================================= */
function scrollToTable(id){
  const el = document.getElementById(id);
  if(!el) return;

  const yOffset = -70; // adjust for fixed top UI
  const y =
    el.getBoundingClientRect().top +
    window.pageYOffset +
    yOffset;

  window.scrollTo({
    top: y,
    behavior: "smooth"
  });
}


/* Initial sync */
redrawAll();


westAspMode.addEventListener("change", redrawAll);

</script>











<script>
/* =========================================
   COLOR PALETTE LOGIC
   ========================================= */


document.querySelectorAll("#colorPalette .colorBox").forEach(box=>{
  box.addEventListener("click",()=>{

    /* remove active from all */
    document.querySelectorAll("#colorPalette .colorBox")
      .forEach(b=>b.classList.remove("active"));

    /* activate clicked */
    box.classList.add("active");

    /* set highlight mode */
    document.body.setAttribute(
      "data-highlight",
      box.dataset.color
    );
  });
});
</script>
















<hr>

<h2 id="table2" style="text-align:center">
TABLE 2 - PLANETARY LEVEL BY LEVEL ANALYZER
</h2>



<div id="pllContainer"></div>




<hr>

<h2 id="table3" style="text-align:center">
TABLE 3 - CUSPAL INTERLINK TABLE
</h2>

<div style="display:flex;justify-content:center">
  <table id="cuspTable" style="max-width:1100px">
    <tr>
      <th>Bhava</th>
      <th>Zodiac Sign</th>
      <th>Degree</th>
      <th>Sign Lord</th>
      <th>Star Lord</th>
      <th>Sub Lord</th>
      <th>Sub-Sub Lord</th>
    </tr>
  </table>
</div>




<hr>

<h2 id="table4" style="text-align:center">
TABLE 4 - STATIC CUSPAL PROMISE READER
</h2>



<div style="text-align:center;margin-bottom:14px;font-weight:800">
  <label>
    <input type="checkbox" id="rotateCuspalMode" checked>
    Rotate As Per Cusp
  </label>
</div>

<div id="cuspalPromiseContainer"></div>




<h2 id="table5" style="text-align:center">
TABLE 5 - DYNAMIC CUSPAL PROMISE READER
</h2>

<div style="text-align:center;margin-bottom:14px;font-weight:800">
  <label>
    <input type="checkbox" id="rotateDynamicCuspalMode" checked>
    Rotate As Per Cusp
  </label>
</div>

<div id="dynamicCuspalPromiseContainer"></div>





<script>

function isRetroPlanet(p){

  if(!window.__planetRetro) return false;

  // üîí STRICT ALLOWED RETRO PLANETS ONLY
  const RETRO_ALLOWED = new Set([
    "Surya","Chandra","Mangala",
    "Budha","Jupiter","Venus","Saturn",
    "Rahu","Ketu"
  ]);

  if(!RETRO_ALLOWED.has(p)) return false;
  
  
  // üî• NODES ARE ALWAYS RETRO (ASTRONOMICAL RULE)
if(p === "Rahu" || p === "Ketu") return true;


  return window.__planetRetro[p] === true;
}










const PLANET_SHORT = {
  Surya:"Sy",
  Chandra:"Ch",
  Mangala:"Ma",
  Rahu:"Ra",
  Jupiter:"Ju",
  Saturn:"Sa",
  Budha:"Bu",
  Ketu:"Ke",
  Venus:"Ve",
  Lagna:"Lg"
};


function getPlanetHouse(entity){
  return getHouseFromPivot(entity);
}







function getConjunctPlanets(entity){

  let baseAbs = getAbsDeg(entity);
  if(baseAbs === null) return "";

  let list = [];

  planets.forEach(p=>{
    if(p === entity) return;
	if(p === "Lagna") return;   // ‚ùå Lagna is NOT a conjunct planet


    let pAbs = getAbsDeg(p);
    if(pAbs === null) return;

    let diff = Math.abs(baseAbs - pAbs);
    if(diff > 180) diff = 360 - diff;

    if(diff <= 13){

      let set = new Set();

      /* placed house */
      set.add(getHouseFromPivot(p));

      /* lordships */
      let lords =
        (p==="Rahu"||p==="Ketu")
        ? getRahuKetuHouseLordships(p)
        : getHouseLordships(p);

      lords.split(",").forEach(x=>{
        if(x) set.add(+x);
      });

      list.push(
        `${PLANET_SHORT[p]}(${[...set].sort((a,b)=>a-b).join(",")})`
      );
    }
  });

  return list.join(", ");
}






const VEDIC_ASPECTS = {
  Surya:[7],
  Chandra:[7],
  Budha:[7],
  Venus:[7],

  Mangala:[4,7,8],
  Jupiter:[5,7,9],
  Saturn:[3,7,10],

  Rahu:[5,7,9],
  Ketu:[5,7,9]
};








function getAspectingHouses(planet){

  let baseHouse = getHouseFromPivot(planet);
  if(!baseHouse) return "";

  let aspects = VEDIC_ASPECTS[planet] || [7];

  let houses = aspects.map(a=>{
    let h = baseHouse + (a - 1);
    if(h > 12) h -= 12;
    return h;
  });

  return houses.join(",");
}







function getAspectingPlanets(entity){

  let result = [];

  let baseHouse = getHouseFromPivot(entity);
  if(!baseHouse) return "";

  /* aspects of the GIVEN planet */
  let aspects = VEDIC_ASPECTS[entity] || [7];

  aspects.forEach(a => {

    let targetHouse = baseHouse + (a - 1);
    if(targetHouse > 12) targetHouse -= 12;

    /* search which planets are sitting in this house */
    planets.forEach(p => {

      if(p === "Lagna") return;   // ‚ùå ignore Lagna
	  if(p === "Rahu" || p === "Ketu") return;   // ‚ùå remove nodes from Aspecting
      if(p === entity) return;

      let pHouse = getHouseFromPivot(p);
      if(pHouse !== targetHouse) return;

      let set = new Set();

      /* placed house */
      set.add(pHouse);

      /* lordships */
      let lords =
        (p==="Rahu"||p==="Ketu")
        ? getRahuKetuHouseLordships(p)
        : getHouseLordships(p);

      lords.split(",").forEach(x=>{
        if(x) set.add(+x);
      });

      result.push(
        `${PLANET_SHORT[p]}(${[...set].sort((a,b)=>a-b).join(",")})`
      );

    });
  });

  return [...new Set(result)].join(", ");
}










function getAspectedBy(entity){

  let list = [];

  planets.forEach(p=>{

    if(p === "Lagna") return;   // ‚ùå Lagna never aspects
    if(p === entity) return;

    /* ‚ùå remove Rahu ‚Üî Ketu mutual aspect */
    if(
      (entity==="Rahu" && p==="Ketu") ||
      (entity==="Ketu" && p==="Rahu")
    ){
      return;
    }

    let aspects = VEDIC_ASPECTS[p] || [7];
    let pHouse = getHouseFromPivot(p);
    let eHouse = getHouseFromPivot(entity);

    aspects.forEach(a=>{
      let h = pHouse + (a - 1);
      if(h > 12) h -= 12;

      if(h === eHouse){
        list.push(PLANET_SHORT[p]);
      }
    });
  });

  return [...new Set(list)].join(", ");
}








function getSummation(planet){

  let set = new Set();

  /* placed house */
  set.add(getHouseFromPivot(planet));

  /* lordships */
  let lords =
    (planet==="Rahu"||planet==="Ketu")
    ? getRahuKetuHouseLordships(planet)
    : getHouseLordships(planet);

  lords.split(",").forEach(x=>{
    if(x) set.add(+x);
  });

  return [...set].sort((a,b)=>a-b).join(",");
}




function getCounterSummation(forward, lordshipText){

  let set = new Set();

  // forward house
  if(forward) set.add(+forward);

  // lordship houses
  if(lordshipText){
    lordshipText
      .split(",")
      .map(x=>+x)
      .filter(x=>!isNaN(x))
      .forEach(x=>set.add(x));
  }

  return [...set].sort((a,b)=>a-b).join(",");
}












/* =========================================================
   KP CONSTANTS
   ========================================================= */

/*
Vimshottari Dasha order (fixed sequence)
This order is used for:
- Star lord
- Sub lord
- Sub-sub lord
*/
const KP_DASHA_ORDER = [
  "Ketu","Venus","Surya","Chandra","Mangala",
  "Rahu","Jupiter","Saturn","Budha"
];

/*
Vimshottari years for each planet
These decide the LENGTH of sub divisions
*/
const KP_DASHA_YEARS = {
  Ketu:7,
  Venus:20,
  Surya:6,
  Chandra:10,
  Mangala:7,
  Rahu:18,
  Jupiter:16,
  Saturn:19,
  Budha:17
};

/*
Each Nakshatra length = 13¬∞20‚Ä≤ = 13.333333¬∞
*/
const NAKSHATRA_LEN = 13 + 20/60;










/* =========================================================
   COLLECT ALL STAR LORDS PRESENT IN CURRENT CHART
   ========================================================= */
function getAllStarLordsPresent(){

  let set = new Set();

  planets.forEach(p => {

    if(p === "Lagna") return;

    let star = getStarLord(p);
    if(star){
      set.add(star);
    }

  });

  return set; // Set of planets acting as Star Lords
}





/* =========================================================
   CHECK IF PLANET IS TENANTED
   ========================================================= */
function isTenantedPlanet(planet){

  // Lagna is never marked
  if(planet === "Lagna") return false;

  let starLordsPresent = getAllStarLordsPresent();

  // If planet NOT present as Star Lord ‚Üí TENANTED
  return !starLordsPresent.has(planet);
}








/* =========================================================
   CHECK IF PLANET SHARES STAR OR SUB LORD ( % SYMBOL )
   ========================================================= */



/* =========================================================
   CHECK IF PLANET IS IN OWN STAR OR OWN SUB ( % SYMBOL )
   ========================================================= */
function isInOwnStarOrSub(planet){

  // Lagna never qualifies
  if(planet === "Lagna") return false;

  const star = getStarLord(planet);
  const sub  = getSubLord(planet);

  // OWN STAR or OWN SUB
  return (planet === star) || (planet === sub);
}







/* =========================================================
   CHECK IF PLANET IS IN STAR EXCHANGE (# SYMBOL)
   ========================================================= */
function isStarExchangePlanet(planet){

  // Lagna never participates
  if(planet === "Lagna") return false;

  const star = getStarLord(planet);
  if(!star || star === planet) return false;

  // mutual exchange
  return getStarLord(star) === planet;
}











/* =========================================================
   TARA CONSTANTS
   ========================================================= */

/*
Fixed Vimshottari sequence for Tara
*/
const TARA_SEQUENCE = [
  "Janma",
  "Sampath",
  "Vipath",
  "Kshema",
  "Pratyari",
  "Sadhana",
  "Nidana",
  "Mithra",
  "Ati Mitra Shatru"
];

/*
Planet order same as Vimshottari Dasha
*/
const TARA_PLANET_ORDER = [
  "Ketu","Venus","Surya","Chandra",
  "Mangala","Rahu","Jupiter","Saturn","Budha"
];









/* =========================================================
   CALCULATE TARA (LABEL ONLY ‚Äî NO PLANET NAME)
   ========================================================= */



function getTaraLabel(actualPlanet, basePlanet){

  let mode = document.getElementById("taraMode").value;
  let pivot = document.getElementById("kundaliPivot").value;

  let janmaPlanet = "";







  /* =========================
     MODE : SSL OF CHANDRA (DEFAULT)
     ========================= */
  if(mode === "SSL_OF_CHANDRA"){

    // KP Sub-Sub Lord of Chandra
    janmaPlanet = getSubSubLord("Chandra");
  }
  
  
  
  
  /* =========================
   MODE : SL OF CHANDRA
   ========================= */
else if(mode === "SL_OF_CHANDRA"){

  // KP Sub Lord of Chandra
  janmaPlanet = getSubLord("Chandra");
}

/* =========================
   MODE : NL OF CHANDRA
   ========================= */
else if(mode === "NL_OF_CHANDRA"){

  // Nakshatra Lord (Star Lord) of Chandra
  janmaPlanet = getStarLord("Chandra");
}

  
  
  
  
  

  /* =========================
     MODE : STAR LORD
     ========================= */
  else if(mode === "Star Lord"){

    if(pivot === "Lagna"){
      janmaPlanet = getStarLord("Lagna");
    }else{
      janmaPlanet = getStarLord(pivot);
    }
  }

  /* =========================
     MODE : PLANET (PIVOT)
     ========================= */
  else if(mode === "Planet"){
    janmaPlanet = pivot;
  }

  /* =========================
     MODE : FIXED PLANET
     ========================= */
  else{
    janmaPlanet = mode; // Surya, Chandra, Mangala, etc.
  }










  if(!janmaPlanet || !actualPlanet){
    return "";
  }

  let janmaIndex = TARA_PLANET_ORDER.indexOf(janmaPlanet);
  let actualIndex = TARA_PLANET_ORDER.indexOf(actualPlanet);

  if(janmaIndex === -1 || actualIndex === -1) return "";

  let diff = actualIndex - janmaIndex;
  if(diff < 0) diff += 9;

  return TARA_SEQUENCE[diff];
}

















/*
Returns the Nakshatra lord of a planet
*/
function getStarLord(entity){

  let abs = getAbsDeg(entity);
  if(abs === null) return "";

  /* Position inside zodiac */
  let pos = abs % 360;

  /* Which Nakshatra index (0‚Äì26) */
  let starIndex = Math.floor(pos / NAKSHATRA_LEN);

  /* Each 3 Nakshatras repeat dasha order */
  let lordIndex = starIndex % 9;

  return KP_DASHA_ORDER[lordIndex];
}















/*
Returns Sub Lord based on KP Vimshottari proportions
*/



function getSubLord(entity){

  let abs = getAbsDeg(entity);
  if(abs === null) return "";

  let posInStar = abs % NAKSHATRA_LEN;

  let starLord = getStarLord(entity);
  let startIndex = KP_DASHA_ORDER.indexOf(starLord);

  let totalYears = 120;
  let acc = 0;

  for(let i=0;i<9;i++){

    let p = KP_DASHA_ORDER[(startIndex + i) % 9];

    let portion =
      (KP_DASHA_YEARS[p] / totalYears) * NAKSHATRA_LEN;

    acc += portion;

    if(posInStar <= acc){
      return p;
    }
  }

  return "";
}











/*
Star lord of the Sub Lord planet
*/
function getStarOfSubLord(entity){

  let sub = getSubLord(entity);
  if(!sub) return "";

  return getStarLord(sub);
}






/*
Returns Sub-Sub Lord using Vimshottari again
*/


function getSubSubLord(entity){

  let abs = getAbsDeg(entity);
  if(abs === null) return "";

  let posInStar = abs % NAKSHATRA_LEN;

  let starLord = getStarLord(entity);
  let subLord  = getSubLord(entity);

  let starIndex = KP_DASHA_ORDER.indexOf(starLord);
  let subIndex  = KP_DASHA_ORDER.indexOf(subLord);

  let totalYears = 120;
  let acc = 0;

  for(let i=0;i<9;i++){

    let p = KP_DASHA_ORDER[(starIndex + i) % 9];
    let pLen = (KP_DASHA_YEARS[p] / totalYears) * NAKSHATRA_LEN;

    if(posInStar > acc && posInStar <= acc + pLen){

      let posInSub = posInStar - acc;
      let acc2 = 0;

      for(let j=0;j<9;j++){
        let q = KP_DASHA_ORDER[(subIndex + j) % 9];
        let qLen = (KP_DASHA_YEARS[q] / totalYears) * pLen;

        acc2 += qLen;

        if(posInSub <= acc2){
          return q;
        }
      }
    }

    acc += pLen;
  }

  return "";
}












/*
Star lord of the Sub-Sub Lord planet
*/
function getStarOfSubSub(entity){

  let subsub = getSubSubLord(entity);
  if(!subsub) return "";

  return getStarLord(subsub);
}










/*
Returns actual planet name for each KP level
*/
function resolveEntity(entity, level){

  if(level === "Planet") return entity;
  if(level === "Star Lord") return getStarLord(entity);
  if(level === "Sub Lord") return getSubLord(entity);
  if(level === "Star of Sub Lord") return getStarOfSubLord(entity);
  if(level === "Sub-Sub") return getSubSubLord(entity);
  if(level === "Star of Sub-Sub") return getStarOfSubSub(entity);

  return "";
}








const KP_LEVELS = [
  "Planet",
  "Star Lord",
  "Sub Lord",
  "Star of Sub Lord",
  "Sub-Sub",
  "Star of Sub-Sub"
];











function buildPLLTables(){

  const container = document.getElementById("pllContainer");
  container.innerHTML = ""; // clear old tables

  const PLL_PLANETS =
  (document.getElementById("kundaliPivot").value === "Lagna")
  ? ["Surya","Chandra","Mangala","Rahu","Jupiter","Saturn","Budha","Ketu","Venus"]
  : (()=>{

      let base = ["Surya","Chandra","Mangala","Rahu","Jupiter","Saturn","Budha","Ketu","Venus"];
      let p = document.getElementById("kundaliPivot").value;
      let i = base.indexOf(p);
      return i===-1 ? base : [...base.slice(i),...base.slice(0,i)];
    })();


  PLL_PLANETS.forEach(p => {

    /* ---------- HEADING ---------- */
    let h = document.createElement("h3");
    h.style.textAlign = "center";
    h.style.marginTop = "30px";
    h.textContent = `PLANET : ${p}`;
    container.appendChild(h);

    /* ---------- TABLE ---------- */
    let table = document.createElement("table");
    table.style.maxWidth = "1400px";
    table.style.margin = "0 auto";

    table.innerHTML = `
      <tr>
        <th>Entity</th>
		<th>Planet</th>
		<th>House</th>
		<th>Lords Of</th>
		<th>Summation</th>
		<th>Conjunct Planets</th>
		<th>Aspecting</th>
		<th>Aspecting Houses</th>
		<th>Aspected By</th>
		<th>Tara</th>


      </tr>
    `;

    /* ---------- 6 LEVELS ---------- */
    KP_LEVELS.forEach(level => {

      let actual = resolveEntity(p, level);
      if(!actual) return;

      
	  
	  
	  
	  
	  let r = table.insertRow();

		/* ===== LEVEL ‚Üí ROW CLASS ===== */
		if(level === "Planet" || level === "Star Lord"){
		  r.classList.add("lvl-planet");
		}
		else if(level === "Sub Lord" || level === "Star of Sub Lord"){
		  r.classList.add("lvl-sub");
		}
		else if(level === "Sub-Sub" || level === "Star of Sub-Sub"){
		  r.classList.add("lvl-subsub");
		}

		r.insertCell().textContent = level;

	  
	  
	  
      // Planet name with TENANTED indicator
		let planetLabel = actual;

		if(isRetroPlanet(actual)){
		  planetLabel += " (R)";
		}

		if(isTenantedPlanet(actual)){
		  planetLabel += " $";
		}
		
		
		if(isInOwnStarOrSub(actual)){
		  planetLabel += " %";
		}

		if(isStarExchangePlanet(actual)){
		  planetLabel += " #";
		}

		


		r.insertCell().textContent = planetLabel;


      r.insertCell().textContent = getHouseFromPivot(actual);

      let lords =
        (actual==="Rahu"||actual==="Ketu")
        ? getRahuKetuHouseLordships(actual)
        : getHouseLordships(actual);

      r.insertCell().textContent = lords;
	r.insertCell().textContent = getSummation(actual);
	r.insertCell().textContent = getConjunctPlanets(actual);
	r.insertCell().textContent = getAspectingPlanets(actual);
	r.insertCell().textContent = getAspectingHouses(actual);
	r.insertCell().textContent = getAspectedBy(actual);
	// TARA COLUMN
	r.insertCell().textContent = getTaraLabel(actual, p);




    });

    container.appendChild(table);
  });
}


























/* =========================================
   FINAL PLL REDRAW (FIXED ORDER)
   ========================================= */

function redrawPLL(){
  buildPLLTables();
}


/* ===== TARA MODE CHANGE LISTENER (NEW) ===== */
document.getElementById("taraMode")
  ?.addEventListener("change", redrawPLL);
/* ========================================== */


/* ===== INITIAL DRAW (FORCE VISIBLE TABLES) ===== */
setTimeout(redrawPLL, 0);



/* EVENT HOOKS */
["kundaliPivot","sign2signMode","kpMode","vedicMode"]
.forEach(id=>{
  document.getElementById(id)
    ?.addEventListener("change", redrawPLL);
});

planets.forEach(p=>{
  ["sign","deg","min","sec"].forEach(k=>{
    document.getElementById(p+"_"+k)
      ?.addEventListener("input", redrawPLL);
  });
});


















</script>












<script>
/* =========================================================
   TABLE 3 : CUSPAL INTERLINK TABLE
   (SWISS JSON DEPENDENT ‚Äî STABLE)
   ========================================================= */
function buildCuspalTable(){

  const table = document.getElementById("cuspTable");
  if(!table) return;

  /* clear old rows but keep header */
  while(table.rows.length > 1){
    table.deleteRow(1);
  }

  /* BTR MODE ‚Äî cusps come from dynamic inputs */
if(!window.__lastSwissData) return;


  /* =========================
     DETERMINE PIVOT HOUSE
     ========================= */
  let pivot = document.getElementById("kundaliPivot")?.value || "Lagna";
let pivotHouse = 1;

/* üî• CSL PIVOT */
if(pivot.endsWith("CSL")){
  pivotHouse = parseInt(pivot,10) || 1;
}

/* üî• PLANET / LAGNA PIVOT */
else if(pivot !== "Lagna"){
  pivotHouse = getHouseFromLagna(pivot) || 1;
}


  /* =========================
     BUILD ROTATED VIEW
     ========================= */
  for(let displayBhava = 1; displayBhava <= 12; displayBhava++){

    /* Map displayed bhava to original bhava */
    let originalBhava =
      ((pivotHouse + displayBhava - 2) % 12) + 1;

    const r = table.insertRow();

    /* ---------- Bhava (FIXED DISPLAY) ---------- */
    r.insertCell().textContent = displayBhava;

    let abs = getAbsDeg(originalBhava + "CSL");
    if(typeof abs !== "number"){

      for(let i=0;i<6;i++) r.insertCell().textContent = "";
      continue;
    }

    abs = ((abs % 360) + 360) % 360;

    /* ---------- Zodiac Sign ---------- */
    let signIndex = Math.floor(abs / 30);
    let sign = signs[signIndex + 1] || "";
    r.insertCell().textContent = sign;

    /* ---------- Degree ---------- */
    let degFloat = abs % 30;
    let deg = Math.floor(degFloat);
    let minFloat = (degFloat - deg) * 60;
    let min = Math.floor(minFloat);
    let sec = Math.round((minFloat - min) * 60);

    if(sec === 60){ sec = 0; min++; }
    if(min === 60){ min = 0; deg++; }

    r.insertCell().textContent =
      `${deg}¬∞ ${min}' ${sec}"`;

    /* ---------- Sign Lord ---------- */
    r.insertCell().textContent = SIGN_LORDS[sign] || "";

    /* ---------- KP LORDS (FROM ORIGINAL BHAVA) ---------- */

    function cuspStarLord(absDeg){
      let starIndex = Math.floor((absDeg % 360) / NAKSHATRA_LEN);
      return KP_DASHA_ORDER[starIndex % 9];
    }

    function cuspSubLord(absDeg){
      let posInStar = absDeg % NAKSHATRA_LEN;
      let starLord = cuspStarLord(absDeg);
      let startIndex = KP_DASHA_ORDER.indexOf(starLord);

      let acc = 0;
      for(let i=0;i<9;i++){
        let p = KP_DASHA_ORDER[(startIndex + i) % 9];
        let portion =
          (KP_DASHA_YEARS[p] / 120) * NAKSHATRA_LEN;
        acc += portion;
        if(posInStar <= acc) return p;
      }
      return "";
    }

    function cuspSubSubLord(absDeg){
      let posInStar = absDeg % NAKSHATRA_LEN;
      let starLord = cuspStarLord(absDeg);
      let subLord  = cuspSubLord(absDeg);

      let starIndex = KP_DASHA_ORDER.indexOf(starLord);
      let subIndex  = KP_DASHA_ORDER.indexOf(subLord);

      let acc = 0;
      for(let i=0;i<9;i++){
        let p = KP_DASHA_ORDER[(starIndex + i) % 9];
        let pLen =
          (KP_DASHA_YEARS[p] / 120) * NAKSHATRA_LEN;

        if(posInStar > acc && posInStar <= acc + pLen){

          let posInSub = posInStar - acc;
          let acc2 = 0;

          for(let j=0;j<9;j++){
            let q = KP_DASHA_ORDER[(subIndex + j) % 9];
            let qLen =
              (KP_DASHA_YEARS[q] / 120) * pLen;
            acc2 += qLen;
            if(posInSub <= acc2) return q;
          }
        }
        acc += pLen;
      }
      return "";
    }

    r.insertCell().textContent = cuspStarLord(abs);
    r.insertCell().textContent = cuspSubLord(abs);
    r.insertCell().textContent = cuspSubSubLord(abs);
  }
}






/* ---------- HARD LINK TO REDRAW ---------- */
function redrawCusps(){
  buildCuspalTable();
}

/* ---------- CALL ON ALL MAJOR EVENTS ---------- */
setTimeout(redrawCusps, 0);

document.getElementById("trueNodeMode")
  ?.addEventListener("change", redrawCusps);
  
  
  
  
  /* üî• ROTATE TABLE 3 WHEN PIVOT CHANGES */
document.getElementById("kundaliPivot")
  ?.addEventListener("change", redrawCusps);

/* üî• ROTATE TABLE 3 WHEN MODE CHANGES */
["sign2signMode","kpMode","vedicMode"]
.forEach(id=>{
  document.getElementById(id)
    ?.addEventListener("change", redrawCusps);
});


</script>











<script>
/* =========================================================
   SWISS EPHEMERIS JSON LOADER (OFFLINE)
   ========================================================= */

function absToSignDeg(abs){
  abs = ((abs % 360) + 360) % 360;

  let signIndex = Math.floor(abs / 30); // 0‚Äì11
  let degFloat = abs % 30;

  let deg = Math.floor(degFloat);
  let minFloat = (degFloat - deg) * 60;
  let min = Math.floor(minFloat);
  let sec = Math.round((minFloat - min) * 60);

  if(sec === 60){ sec = 0; min++; }
  if(min === 60){ min = 0; deg++; }

  return {
    sign: signs[signIndex + 1],
    deg,
    min,
    sec
  };
}







/* =========================================================
   BTR INIT FROM SWISS META (UTC ‚Üí LOCAL SAFE)
   ========================================================= */
function initBTRFromSwiss(meta){

  if(!meta || !meta.datetime_utc) return;

  /* Parse ISO UTC datetime */
  const dt = new Date(meta.datetime_utc);
  if(isNaN(dt.getTime())) return;

  /* Fill UI boxes */
  btr_dd.value   = String(dt.getDate()).padStart(2,"0");
  btr_mm.value   = String(dt.getMonth()+1).padStart(2,"0");
  btr_yyyy.value = dt.getFullYear();

  btr_hh.value  = String(dt.getHours()).padStart(2,"0");
  btr_min.value = String(dt.getMinutes()).padStart(2,"0");
  btr_sec.value = String(dt.getSeconds()).padStart(2,"0");

  /* Immutable base birth time */
  window.__btrBaseTime =
    new Date(dt.getTime());
	syncMiniBTR();


  /* Current working time (for rectification) */
  window.__btrCurrentTime =
    new Date(dt.getTime());
	window.__btrReady = true;


		syncBTRUIFromTime();

/* üî• FORCE MINI BAR TO SHOW CHART TIME IMMEDIATELY */
syncMiniBTR();

recomputeFromBTR();


}






function loadSwissJSON(){

  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".json";

  input.onchange = e => {

    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();

    reader.onload = () => {


	let data;
	try{
	  data = JSON.parse(reader.result);
	  window.__lastSwissData = data; // cache for True / Mean node toggle
	  // ===== STORE RETROGRADE FLAGS (GLOBAL) =====
	 window.__planetRetro = data.planets_retro || {};

	  initBTRFromSwiss(data.meta);

	}catch(err){
	  alert("Invalid JSON file");
	  return;
	}


      /* =========================================================
         FORMAT DETECTION
         Supports:
         1) Old Swiss JSON  { Surya: 123.45 }
         2) New Swiss JSON { lagna, planets:{...} }
         ========================================================= */

      /* ---------- NEW FORMAT ---------- */
      if(data.planets && typeof data.lagna === "number"){

        /* META (NAME + DATE + TIME) */
		if(data.meta){

		  /* NAME */
		  if(data.meta.name){
			document.getElementById("personName").value =
			  data.meta.name.toUpperCase().slice(0,20);
		  }

		  /* DATE : DD-MM-YYYY */
		  if(data.meta.date){
			let [yyyy,mm,dd] = data.meta.date.split("-");
			if(dd && mm && yyyy){
			  btr_dd.value = dd.padStart(2,"0");
			  btr_mm.value = mm.padStart(2,"0");
			  btr_yyyy.value = yyyy;
			}
		  }

		  /* TIME : HH:MM:SS */
		  if(data.meta.time){
			let [hh,mi,ss] = data.meta.time.split(":");
			btr_hh.value  = (hh||"00").padStart(2,"0");
			btr_min.value = (mi||"00").padStart(2,"0");
			btr_sec.value = (ss||"00").padStart(2,"0");
		  }

		  /* üîí STORE IMMUTABLE BASE TIMESTAMP */
		  if(data.meta.date && data.meta.time){
			window.__btrBaseTime =
			  new Date(`${data.meta.date}T${data.meta.time}`);
		  }
		}


        /* LAGNA */
        let lag = absToSignDeg(data.lagna);
        document.getElementById("Lagna_sign").value = lag.sign;
        document.getElementById("Lagna_deg").value  = lag.deg;
        document.getElementById("Lagna_min").value  = lag.min;
        document.getElementById("Lagna_sec").value  = lag.sec;





        /* PLANETS */
        Object.keys(data.planets).forEach(p => {

		  // Handle Rahu / Ketu separately
		  if(p === "Rahu" || p === "Ketu") return;
		  if(p.endsWith("_true")) return;

		  if(!document.getElementById(p+"_sign")) return;

		  let v = absToSignDeg(data.planets[p]);

		  document.getElementById(p+"_sign").value = v.sign;
		  document.getElementById(p+"_deg").value  = v.deg;
		  document.getElementById(p+"_min").value  = v.min;
		  document.getElementById(p+"_sec").value  = v.sec;
		});

		/* ===== NODE HANDLING ===== */
		let rahuKey = USE_TRUE_NODE ? "Rahu_true" : "Rahu";
		let ketuKey = USE_TRUE_NODE ? "Ketu_true" : "Ketu";

		/* ===== NODE HANDLING (RAW, IMMUTABLE) ===== */

			// store RAW Swiss degrees
			window.__rawRahuAbs     = data.planets.Rahu ?? null;
			window.__rawKetuAbs     = data.planets.Ketu ?? null;
			window.__rawRahuTrueAbs = data.planets.Rahu_true ?? null;
			window.__rawKetuTrueAbs = data.planets.Ketu_true ?? null;
			
			
			// üî• SYNC NODE MODE AFTER SWISS LOAD
			USE_TRUE_NODE =
			  document.getElementById("trueNodeMode")?.checked || false;


			// select correct source
			let rahuAbs = USE_TRUE_NODE
			  ? window.__rawRahuTrueAbs
			  : window.__rawRahuAbs;

			let ketuAbs = USE_TRUE_NODE
			  ? window.__rawKetuTrueAbs
			  : window.__rawKetuAbs;

			// apply to UI (NO OFFSETS)
			if(rahuAbs != null){
			  let v = absToSignDeg(rahuAbs);
			  Rahu_sign.value = v.sign;
			  Rahu_deg.value  = v.deg;
			  Rahu_min.value  = v.min;
			  Rahu_sec.value  = v.sec;
			}

			if(ketuAbs != null){
			  let v = absToSignDeg(ketuAbs);
			  Ketu_sign.value = v.sign;
			  Ketu_deg.value  = v.deg;
			  Ketu_min.value  = v.min;
			  Ketu_sec.value  = v.sec;
			}

       // üî• FORCE FULL INITIAL DRAW AFTER SWISS LOAD
		redrawAll();   // includes drawSIKundali + counter table
		redrawPLL();   // ensure PLL sync
		lockPlanetInputs_BTR(true);

		return;

      }

      /* ---------- OLD FORMAT (BACKWARD COMPATIBLE) ---------- */
      planets.forEach(p => {

        if(data[p] == null) return;

        let v = absToSignDeg(data[p]);

        document.getElementById(p+"_sign").value = v.sign;
        document.getElementById(p+"_deg").value  = v.deg;
        document.getElementById(p+"_min").value  = v.min;
        document.getElementById(p+"_sec").value  = v.sec;
      });

      redrawAll();
      redrawPLL();
    };

    reader.readAsText(file);
  };

  input.click();
}









function loadSwissFromCache(data){

  if(!data || !data.planets) return;

  let lag = absToSignDeg(data.lagna);
  Lagna_sign.value = lag.sign;
  Lagna_deg.value  = lag.deg;
  Lagna_min.value  = lag.min;
  Lagna_sec.value  = lag.sec;

  Object.keys(data.planets).forEach(p => {
    if(p === "Rahu" || p === "Ketu") return;
    if(p.endsWith("_true")) return;
    if(!document.getElementById(p+"_sign")) return;

    let v = absToSignDeg(data.planets[p]);
    document.getElementById(p+"_sign").value = v.sign;
    document.getElementById(p+"_deg").value  = v.deg;
    document.getElementById(p+"_min").value  = v.min;
    document.getElementById(p+"_sec").value  = v.sec;
  });

  let rahuKey = USE_TRUE_NODE ? "Rahu_true" : "Rahu";
  let ketuKey = USE_TRUE_NODE ? "Ketu_true" : "Ketu";

  if(data.planets[rahuKey]){
    let v = absToSignDeg(data.planets[rahuKey]);
    Rahu_sign.value = v.sign;
    Rahu_deg.value  = v.deg;
    Rahu_min.value  = v.min;
    Rahu_sec.value  = v.sec;
  }

  if(data.planets[ketuKey]){
    let v = absToSignDeg(data.planets[ketuKey]);
    Ketu_sign.value = v.sign;
    Ketu_deg.value  = v.deg;
    Ketu_min.value  = v.min;
    Ketu_sec.value  = v.sec;
  }

  redrawAll();
  redrawPLL();
}







document.getElementById("trueNodeMode").addEventListener("change", e => {
  USE_TRUE_NODE = e.target.checked;

  // choose correct RAW source
  let rahuAbs = USE_TRUE_NODE
    ? window.__rawRahuTrueAbs
    : window.__rawRahuAbs;

  let ketuAbs = USE_TRUE_NODE
    ? window.__rawKetuTrueAbs
    : window.__rawKetuAbs;

  if(rahuAbs != null){
    let v = absToSignDeg(rahuAbs);
    Rahu_sign.value = v.sign;
    Rahu_deg.value  = v.deg;
    Rahu_min.value  = v.min;
    Rahu_sec.value  = v.sec;
  }

  if(ketuAbs != null){
    let v = absToSignDeg(ketuAbs);
    Ketu_sign.value = v.sign;
    Ketu_deg.value  = v.deg;
    Ketu_min.value  = v.min;
    Ketu_sec.value  = v.sec;
  }

  redrawAll();
  redrawPLL();
});







</script>












<script>
/* =========================================================
   TABLE 4 : CUSPAL PROMISE READER
   FULLY ISOLATED ENGINE
   ========================================================= */

/* ---------- ORDINAL LABEL ---------- */
function cuspOrdinal(n){
  return n + (n===1?"ST":n===2?"ND":n===3?"RD":"TH");
}





/* ---------- GET CUSPAL SUB LORD (FROM SWISS) ---------- */
function getCuspalSubLord(bhava){

  /* üî• BTR-AWARE CUSP SOURCE */
  let abs = getAbsDeg(bhava + "CSL");
  if(typeof abs !== "number") return "";

  abs = ((abs % 360) + 360) % 360;







  let posInStar = abs % NAKSHATRA_LEN;

  let starIndex = Math.floor(abs / NAKSHATRA_LEN);
  let starLord = KP_DASHA_ORDER[starIndex % 9];

  let startIndex = KP_DASHA_ORDER.indexOf(starLord);

  let acc = 0;
  for(let i=0;i<9;i++){
    let p = KP_DASHA_ORDER[(startIndex + i) % 9];
    let portion =
      (KP_DASHA_YEARS[p] / 120) * NAKSHATRA_LEN;
    acc += portion;
    if(posInStar <= acc) return p;
  }

  return "";
}

/* =========================================================
   ISOLATED KP HELPERS (NO SHARED LOGIC)
   ========================================================= */

function CPR_getHouse(p){ return getHouseFromPivot(p); }

function CPR_getLords(p){
  return (p==="Rahu"||p==="Ketu")
    ? getRahuKetuHouseLordships(p)
    : getHouseLordships(p);
}

function CPR_getSummation(p){
  let set=new Set();
  set.add(CPR_getHouse(p));
  CPR_getLords(p).split(",").forEach(x=>x&&set.add(+x));
  return [...set].sort((a,b)=>a-b).join(",");
}

function CPR_getConjunct(p){
  return getConjunctPlanets(p);
}

function CPR_getAspecting(p){
  return getAspectingPlanets(p);
}

function CPR_getAspectingHouses(p){
  return getAspectingHouses(p);
}

function CPR_getAspectedBy(p){
  return getAspectedBy(p);
}








/* =========================================================
   CUSPAL ROTATION ENGINE (ISOLATED)
   ========================================================= */

function rotateHouseForCusp(house, cuspNo){
  if(!document.getElementById("rotateCuspalMode")?.checked){
    return house;
  }

  let rotated = house + (cuspNo - 1);

  while(rotated > 12) rotated -= 12;
  while(rotated <= 0) rotated += 12;

  return rotated;
}









/* rotate comma-separated numbers */
function rotateNumberList(text, cuspNo){
  if(!text) return text;
  return text.split(",")
    .map(x => {
      let n = parseInt(x,10);
      return isNaN(n) ? x : rotateHouseForCusp(n, cuspNo);
    })
    .sort((a,b)=>a-b)
    .join(",");
}

/* rotate numbers inside Planet(1,2,3) */
function rotateEmbedded(text, cuspNo){
  if(!text) return text;

  return text.replace(/\(([^)]+)\)/g, (_, nums) => {
    let rotated =
      nums.split(",")
          .map(n => rotateHouseForCusp(parseInt(n,10), cuspNo))
          .sort((a,b)=>a-b)
          .join(",");
    return `(${rotated})`;
  });
}







/* =========================================================
   DYNAMIC CUSPAL ROTATION (TABLE 5 ONLY)
   ========================================================= */
function rotateHouseForDynamicCusp(house, cuspNo){
  if(!document.getElementById("rotateDynamicCuspalMode")?.checked){
    return house;
  }

  let rotated = house + (cuspNo - 1);

  while(rotated > 12) rotated -= 12;
  while(rotated <= 0) rotated += 12;

  return rotated;
}







/* =========================================================
   BUILD ONE CUSPAL PROMISE TABLE
   ========================================================= */
function buildCuspalPromiseTable(bhava, planet){

  const wrap = document.createElement("div");

  /* ---------- HEADING ---------- */
  const h = document.createElement("h3");
  h.style.textAlign="center";
  h.style.marginTop="28px";
  h.innerHTML =
  `${cuspOrdinal(bhava)} Cuspal Sublord : ` +
  `<span style="color:#facc15;font-weight:900">[ ${planet.toUpperCase()} ]</span>`;

  wrap.appendChild(h);

  /* ---------- TABLE ---------- */
  const table = document.createElement("table");
  table.style.maxWidth="1400px";
  table.style.margin="0 auto";

  table.innerHTML = `
    <tr>
      <th>Entity</th>
      <th>Planet</th>
      <th>House</th>
      <th>Lords Of</th>
      <th>Summation</th>
      <th>Conjunct Planets</th>
      <th>Aspecting</th>
      <th>Aspecting Houses</th>
      <th>Aspected By</th>
      <th>Tara</th>
    </tr>
  `;

  KP_LEVELS.forEach(level=>{

    let actual = resolveEntity(planet, level);
    if(!actual) return;

    
	
	
	let r = table.insertRow();

	/* ===== LEVEL ‚Üí ROW CLASS ===== */
	if(level === "Planet" || level === "Star Lord"){
	  r.classList.add("lvl-planet");
	}
	else if(level === "Sub Lord" || level === "Star of Sub Lord"){
	  r.classList.add("lvl-sub");
	}
	else if(level === "Sub-Sub" || level === "Star of Sub-Sub"){
	  r.classList.add("lvl-subsub");
	}

	r.insertCell().textContent = level;

	
	
	
	
	

    let label = actual;
	
	
		if(isRetroPlanet(actual)){
	  label += " (R)";
	}
	
	
	

	

	if(isTenantedPlanet(actual)){
	  label += " $";
	}
	
	if(isInOwnStarOrSub(actual)){
	  label += " %";
	}
	
	
	
	if(isStarExchangePlanet(actual)){
	  label += " #";
	}



    r.insertCell().textContent = label;

    /* ---------- ROTATED OUTPUT (CUSPAL MODE SAFE) ---------- */

			let house = rotateHouseForCusp(CPR_getHouse(actual), bhava);
			let lords = rotateNumberList(CPR_getLords(actual), bhava);
			let sum   = rotateNumberList(CPR_getSummation(actual), bhava);

			let conj  = rotateEmbedded(CPR_getConjunct(actual), bhava);
			let asp   = rotateEmbedded(CPR_getAspecting(actual), bhava);
			let aspH  = rotateNumberList(CPR_getAspectingHouses(actual), bhava);

			r.insertCell().textContent = house;
			r.insertCell().textContent = lords;
			r.insertCell().textContent = sum;
			r.insertCell().textContent = conj;
			r.insertCell().textContent = asp;
			r.insertCell().textContent = aspH;
			r.insertCell().textContent = CPR_getAspectedBy(actual);
			// TARA COLUMN (RESTORED)
			r.insertCell().textContent = getTaraLabel(actual, planet);


  });

  wrap.appendChild(table);
  return wrap;
}

/* =========================================================
   BUILD FULL CUSPAL PROMISE READER
   ========================================================= */
function buildCuspalPromiseReader(){

  const container =
    document.getElementById("cuspalPromiseContainer");
  if(!container) return;

  container.innerHTML="";

  for(let bhava=1; bhava<=12; bhava++){

    let subLord = getCuspalSubLord(bhava);
    if(!subLord) continue;

    container.appendChild(
      buildCuspalPromiseTable(bhava, subLord)
    );
  }
}

/* =========================================================
   HARD REDRAW LINK
   ========================================================= */
function redrawCuspalPromise(){
  buildCuspalPromiseReader();
}

setTimeout(redrawCuspalPromise,0);

document.getElementById("kundaliPivot")
  ?.addEventListener("change", redrawCuspalPromise);

document.getElementById("taraMode")
  ?.addEventListener("change", redrawCuspalPromise);
 
 document.getElementById("rotateCuspalMode")
  ?.addEventListener("change", redrawCuspalPromise);


</script>
















<script>
/* =========================================================
   TABLE 5 : DYNAMIC CUSPAL PROMISE READER
   FULLY ISOLATED ENGINE
   ========================================================= */





/* ---------- MAP CUSPS DYNAMICALLY ---------- */



function getDynamicCuspalSubLord(dynamicBhava){

  const data = window.__lastSwissData;
  if(!data || !data.cusps) return "";

  const pivot = document.getElementById("kundaliPivot").value;

  /* =================================================
     CASE 1 : LAGNA PIVOT
     (EXACT SAME BEHAVIOR AS TABLE 4)
     ================================================= */
  if(pivot === "Lagna"){
    return getCuspalSubLord(dynamicBhava);
  }

  /* =================================================
     CASE 2 : CSL PIVOT (1CSL ‚Äì 12CSL)
     PURE CUSP-BASED ROTATION
     ================================================= */
  if(pivot.endsWith("CSL")){

    const pivotCusp = parseInt(pivot, 10);
    if(!pivotCusp) return "";

    /* Map Dynamic Bhava ‚Üí Actual Cusp */
    let actualCusp =
      pivotCusp + (dynamicBhava - 1);

    while(actualCusp > 12) actualCusp -= 12;
    while(actualCusp <= 0) actualCusp += 12;

    return getCuspalSubLord(actualCusp);
  }

  /* =================================================
     CASE 3 : PLANET PIVOT
     FALLBACK ‚Üí SAME AS TABLE 4
     ================================================= */
  return getCuspalSubLord(dynamicBhava);
}







/* ---------- BUILD ONE DYNAMIC CUSP TABLE ---------- */
function buildDynamicCuspalPromiseTable(bhava, planet){

  const wrap = document.createElement("div");

  const h = document.createElement("h3");
  h.style.textAlign = "center";
  h.style.marginTop = "28px";
  h.innerHTML =
    `${cuspOrdinal(bhava)} Cuspal Sublord : ` +
    `<span style="color:#facc15;font-weight:900">[ ${planet.toUpperCase()} ]</span>`;

  wrap.appendChild(h);

  const table = document.createElement("table");
  table.style.maxWidth = "1400px";
  table.style.margin = "0 auto";

  table.innerHTML = `
    <tr>
      <th>Entity</th>
      <th>Planet</th>
      <th>House</th>
      <th>Lords Of</th>
      <th>Summation</th>
      <th>Conjunct Planets</th>
      <th>Aspecting</th>
      <th>Aspecting Houses</th>
      <th>Aspected By</th>
      <th>Tara</th>
    </tr>
  `;

  KP_LEVELS.forEach(level => {

    let actual = resolveEntity(planet, level);
    if(!actual) return;

    let r = table.insertRow();

	/* ===== LEVEL ‚Üí ROW CLASS ===== */
	if(level === "Planet" || level === "Star Lord"){
	  r.classList.add("lvl-planet");
	}
	else if(level === "Sub Lord" || level === "Star of Sub Lord"){
	  r.classList.add("lvl-sub");
	}
	else if(level === "Sub-Sub" || level === "Star of Sub-Sub"){
	  r.classList.add("lvl-subsub");
	}

	r.insertCell().textContent = level;

	
	
	
    let label = actual;

	if(isRetroPlanet(actual)){
  label += " (R)";
}



	if(isTenantedPlanet(actual)){
	  label += " $";
	}

	if(isInOwnStarOrSub(actual)){
	  label += " %";
	}
	
	
	
	if(isStarExchangePlanet(actual)){
	  label += " #";
	}


	r.insertCell().textContent = label;








    /* üîÅ INTERNAL ROTATION (AUTO, NO CHECKBOX) */
  let house = bhava === 1
  ? CPR_getHouse(actual)
  : rotateHouseForDynamicCusp(CPR_getHouse(actual), bhava);

let lords = bhava === 1
  ? CPR_getLords(actual)
  : rotateNumberList(
      CPR_getLords(actual)
        .split(",")
        .map(x=>rotateHouseForDynamicCusp(+x,bhava))
        .join(","),
      1
    );

let sum = bhava === 1
  ? CPR_getSummation(actual)
  : rotateNumberList(
      CPR_getSummation(actual)
        .split(",")
        .map(x=>rotateHouseForDynamicCusp(+x,bhava))
        .join(","),
      1
    );

let conj = bhava === 1
  ? CPR_getConjunct(actual)
  : rotateEmbedded(
      CPR_getConjunct(actual)
        .replace(/\d+/g,n=>rotateHouseForDynamicCusp(+n,bhava)),
      1
    );

let asp = bhava === 1
  ? CPR_getAspecting(actual)
  : rotateEmbedded(
      CPR_getAspecting(actual)
        .replace(/\d+/g,n=>rotateHouseForDynamicCusp(+n,bhava)),
      1
    );

let aspH = bhava === 1
  ? CPR_getAspectingHouses(actual)
  : rotateNumberList(
      CPR_getAspectingHouses(actual)
        .split(",")
        .map(x=>rotateHouseForDynamicCusp(+x,bhava))
        .join(","),
      1
    );





    r.insertCell().textContent = house;
    r.insertCell().textContent = lords;
    r.insertCell().textContent = sum;
    r.insertCell().textContent = conj;
    r.insertCell().textContent = asp;
    r.insertCell().textContent = aspH;
    r.insertCell().textContent = CPR_getAspectedBy(actual);
    r.insertCell().textContent = getTaraLabel(actual, planet);
  });

  wrap.appendChild(table);
  return wrap;
}

/* ---------- BUILD FULL TABLE 5 ---------- */
function buildDynamicCuspalPromiseReader(){

  const container =
    document.getElementById("dynamicCuspalPromiseContainer");
  if(!container) return;

  container.innerHTML = "";

  for(let bhava = 1; bhava <= 12; bhava++){

    let subLord = getDynamicCuspalSubLord(bhava);
    if(!subLord) continue;

    container.appendChild(
      buildDynamicCuspalPromiseTable(bhava, subLord)
    );
  }
}

/* ---------- HARD WIRES ---------- */
setTimeout(buildDynamicCuspalPromiseReader, 0);

["kundaliPivot","taraMode","sign2signMode","kpMode","vedicMode"]
.forEach(id=>{
  document.getElementById(id)
    ?.addEventListener("change", buildDynamicCuspalPromiseReader);
});



document.getElementById("rotateDynamicCuspalMode")
  ?.addEventListener("change", buildDynamicCuspalPromiseReader);
  
</script>
















<script>

/* =========================================================
   HOUSE FROM LAGNA (FOR DYNAMIC CUSPAL LOGIC ONLY)
   ========================================================= */
function getHouseFromLagna(entity){

  let savedPivot = document.getElementById("kundaliPivot").value;

  // temporarily force Lagna as pivot
  document.getElementById("kundaliPivot").value = "Lagna";

  let h = getHouseFromPivot(entity);

  // restore pivot
  document.getElementById("kundaliPivot").value = savedPivot;

  return h;
}

</script>



<script>
/* =========================================================
   BTR PATCH 3 ‚Äî TIME SHIFT ENGINE (¬±48 HOURS)
   NO LAGNA MOTION YET
   ========================================================= */

/* base timestamp must already exist (from PATCH 2) */
window.__btrCurrentTime = new Date();


/* hard cap : ¬±48 hours */
const BTR_MAX_SHIFT_SEC = 48 * 60 * 60;

/* ---------- INIT CURRENT TIME ---------- */
function initBTRCurrentTime(){

  let d  = Number(btr_dd.value);
  let m  = Number(btr_mm.value) - 1;
  let y  = Number(btr_yyyy.value);
  let hh = Number(btr_hh.value);
  let mm = Number(btr_min.value);
  let ss = Number(btr_sec.value);

  window.__btrBaseTime =
    new Date(y, m, d, hh, mm, ss);

  window.__btrCurrentTime =
    new Date(window.__btrBaseTime.getTime());
}

/* ---------- SYNC UI FROM CURRENT TIME ---------- */
function syncBTRUIFromTime(){
  if(!window.__btrCurrentTime) return;

  const d = window.__btrCurrentTime;

  btr_dd.value   = String(d.getDate()).padStart(2,"0");
  btr_mm.value   = String(d.getMonth()+1).padStart(2,"0");
  btr_yyyy.value = d.getFullYear();

  btr_hh.value  = String(d.getHours()).padStart(2,"0");
  btr_min.value = String(d.getMinutes()).padStart(2,"0");
  btr_sec.value = String(d.getSeconds()).padStart(2,"0");
}

/* ---------- HARD-CAPPED SHIFT ---------- */
function shiftBTRSeconds(delta){

  if(!window.__btrBaseTime || !window.__btrCurrentTime) return;

  let next =
    new Date(window.__btrCurrentTime.getTime() + delta*1000);

  let diffSec =
    (next.getTime() - window.__btrBaseTime.getTime()) / 1000;

  if(Math.abs(diffSec) > BTR_MAX_SHIFT_SEC){
    return; // üîí HARD STOP
  }

  window.__btrCurrentTime = next;
syncBTRUIFromTime();

/* üîí CAPTURE ACTIVE BTR REFERENCE */
window.__btrActiveAnchor = (() => {
  const refs = [...document.querySelectorAll(BTR_REFERENCE_SELECTOR)];
  const topY = 90; // below floating bar
  let best = null;
  let bestDist = Infinity;

  refs.forEach(el => {
    const r = el.getBoundingClientRect();
    if(r.top <= topY + 5 && r.bottom > topY){
      const dist = Math.abs(r.top - topY);
      if(dist < bestDist){
        bestDist = dist;
        best = el;
      }
    }
  });

  return best;
})();

recomputeFromBTR();


}

/* ---------- ARROW KEY HANDLER ---------- */
document.addEventListener("keydown", e => {

  const el = document.activeElement;
  if(!el || !el.id) return;

  let step = 0;

  switch(el.id){
    case "btr_sec": step = 1; break;
    case "btr_min": step = 60; break;
    case "btr_hh":  step = 3600; break;
    case "btr_dd":  step = 86400; break;
    default: return;
  }

  if(e.key === "ArrowUp"){
    e.preventDefault();
    shiftBTRSeconds(step);
  }

  if(e.key === "ArrowDown"){
    e.preventDefault();
    shiftBTRSeconds(-step);
  }
});

/* ---------- MANUAL EDIT SYNC ---------- */
function manualBTRSync(){

  if(!window.__btrBaseTime) return;

  let d = Number(btr_dd.value);
  let m = Number(btr_mm.value) - 1;
  let y = Number(btr_yyyy.value);

  let hh = Number(btr_hh.value);
  let mm = Number(btr_min.value);
  let ss = Number(btr_sec.value);

  let next = new Date(y,m,d,hh,mm,ss);

  let diffSec =
    (next.getTime() - window.__btrBaseTime.getTime()) / 1000;

  if(Math.abs(diffSec) > BTR_MAX_SHIFT_SEC){
    syncBTRUIFromTime(); // snap back
    return;
  }

  window.__btrCurrentTime = next;
}

/* ---------- HOOK INPUTS ---------- */
[btr_dd,btr_mm,btr_yyyy,btr_hh,btr_min,btr_sec]
.forEach(el=>{
  el.addEventListener("change", manualBTRSync);
});

/* ---------- AUTO INIT AFTER SWISS LOAD ---------- */
document.addEventListener("swissLoaded", ()=>{
  initBTRCurrentTime();
  syncBTRUIFromTime();
});
</script>














<script>

   
   
   
   
   
   
   
   










function recomputeFromBTR(){

  if(window.__btrLock) return;
  window.__btrLock = true;

  if(
    !window.__lastSwissData ||
    !window.__btrBaseTime ||
    !window.__btrCurrentTime
  ){
    window.__btrLock = false;
    return;
  }


  const deltaSec =
    (window.__btrCurrentTime.getTime() -
     window.__btrBaseTime.getTime()) / 1000;

  const shiftDeg = deltaSec / 240;

  /* üî• SINGLE SOURCE OF TRUTH */
  window.__btrAbs = {};

  /* ===== LAGNA ===== */
  window.__btrAbs["Lagna"] =
    ((window.__lastSwissData.lagna + shiftDeg) % 360 + 360) % 360;

  /* ===== CUSPS ===== */
  if(window.__lastSwissData.cusps){
    for(let i=1;i<=12;i++){
      let base = window.__lastSwissData.cusps[i];
      if(typeof base === "number"){
        window.__btrAbs[i + "CSL"] =
          ((base + shiftDeg) % 360 + 360) % 360;
      }
    }
  }

  /* ===== PLANETS ===== */
  
  
  
  
  /* ===== RAHU / KETU ‚Äî TRUE vs MEAN (BTR SAFE OVERRIDE) ===== */
if(window.__rawRahuAbs != null){

  const rahuBase =
    USE_TRUE_NODE && window.__rawRahuTrueAbs != null
      ? window.__rawRahuTrueAbs
      : window.__rawRahuAbs;

  window.__btrAbs["Rahu"] =
    ((rahuBase + shiftDeg) % 360 + 360) % 360;
}

if(window.__rawKetuAbs != null){

  const ketuBase =
    USE_TRUE_NODE && window.__rawKetuTrueAbs != null
      ? window.__rawKetuTrueAbs
      : window.__rawKetuAbs;

  window.__btrAbs["Ketu"] =
    ((ketuBase + shiftDeg) % 360 + 360) % 360;
}

  
  
  
  
  const basePlanets = window.__lastSwissData.planets || {};
  Object.keys(basePlanets).forEach(p=>{
  if(p === "Rahu" || p === "Ketu" || p === "Rahu_true" || p === "Ketu_true") return;
    if(typeof basePlanets[p] === "number"){
      window.__btrAbs[p] =
        ((basePlanets[p] + shiftDeg) % 360 + 360) % 360;
    }
  });

    /* ===== SYNC UI INPUTS FROM BTR (VISUAL ONLY) ===== */
  Object.keys(window.__btrAbs).forEach(key => {

    /* Skip CSL (no visible inputs) */
    if(key.endsWith("CSL")) return;

    const abs = window.__btrAbs[key];
    if(typeof abs !== "number") return;

    const d = absToSignDeg(abs);

    if(document.getElementById(key + "_sign")){
      document.getElementById(key + "_sign").value = d.sign;
      document.getElementById(key + "_deg").value  = d.deg;
      document.getElementById(key + "_min").value  = d.min;
      document.getElementById(key + "_sec").value  = d.sec;
    }
  });



		const anchor = window.__btrActiveAnchor;
		let anchorOffset = 0;

		if(anchor){
		  anchorOffset = anchor.getBoundingClientRect().top;
		}

		redrawAll();

		requestAnimationFrame(() => {
		  if(anchor){
			const newTop = anchor.getBoundingClientRect().top;
			const delta = newTop - anchorOffset;
			window.scrollBy(0, delta);
		  }
		  window.__btrLock = false;
		});




  
}












function syncMiniBTR(){

  /* üö´ do nothing until Swiss JSON initializes BTR */
  if(!window.__btrReady || !window.__btrCurrentTime) return;

  btrMiniMin.value =
    String(window.__btrCurrentTime.getMinutes()).padStart(2,"0");

  btrMiniSec.value =
    String(window.__btrCurrentTime.getSeconds()).padStart(2,"0");
}




/* update mini inputs whenever main sync happens */
const _oldSync = syncBTRUIFromTime;
syncBTRUIFromTime = function(){
  _oldSync();
  syncMiniBTR();
};








/* manual typing in mini boxes */
[btrMiniMin, btrMiniSec].forEach(el => {

  /* react immediately on typing + arrows */
  el.addEventListener("input", () => {

    if(!window.__btrCurrentTime || !window.__btrBaseTime) return;

    let m = parseInt(btrMiniMin.value,10);
    let s = parseInt(btrMiniSec.value,10);

    if(isNaN(m)) m = window.__btrCurrentTime.getMinutes();
    if(isNaN(s)) s = window.__btrCurrentTime.getSeconds();

    m = Math.max(0, Math.min(59, m));
    s = Math.max(0, Math.min(59, s));

    const d = new Date(window.__btrCurrentTime);
    d.setMinutes(m);
    d.setSeconds(s);

    window.__btrCurrentTime = d;

    /* üî• THIS WAS MISSING */
    manualBTRSync();
    recomputeFromBTR();
  });

});








</script>






</body>
</html>
